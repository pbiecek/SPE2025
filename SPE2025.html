<!DOCTYPE html>
<html lang="en"><head>
<script src="SPE2025_files/libs/clipboard/clipboard.min.js"></script>
<script src="SPE2025_files/libs/quarto-html/tabby.min.js"></script>
<script src="SPE2025_files/libs/quarto-html/popper.min.js"></script>
<script src="SPE2025_files/libs/quarto-html/tippy.umd.min.js"></script>
<link href="SPE2025_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="SPE2025_files/libs/quarto-html/light-border.css" rel="stylesheet">
<link href="SPE2025_files/libs/quarto-html/quarto-html.min.css" rel="stylesheet" data-mode="light">
<link href="SPE2025_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles"><meta charset="utf-8">
  <meta name="generator" content="quarto-1.3.450">

  <meta name="author" content="Przemyslaw Biecek and Nuno Henriques dos Santos de Sepulveda">
  <meta name="dcterms.date" content="2025-10-22">
  <title>The Hitchhiker’s Guide to Responsible Machine Learning</title>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">
  <link rel="stylesheet" href="SPE2025_files/libs/revealjs/dist/reset.css">
  <link rel="stylesheet" href="SPE2025_files/libs/revealjs/dist/reveal.css">
  <style>
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    div.columns{display: flex; gap: min(4vw, 1.5em);}
    div.column{flex: auto; overflow-x: auto;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    ul.task-list li input[type="checkbox"] {
      width: 0.8em;
      margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
      vertical-align: middle;
    }
    /* CSS for syntax highlighting */
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      { color: #003b4f; background-color: #f1f3f5; }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span { color: #003b4f; } /* Normal */
    code span.al { color: #ad0000; } /* Alert */
    code span.an { color: #5e5e5e; } /* Annotation */
    code span.at { color: #657422; } /* Attribute */
    code span.bn { color: #ad0000; } /* BaseN */
    code span.bu { } /* BuiltIn */
    code span.cf { color: #003b4f; } /* ControlFlow */
    code span.ch { color: #20794d; } /* Char */
    code span.cn { color: #8f5902; } /* Constant */
    code span.co { color: #5e5e5e; } /* Comment */
    code span.cv { color: #5e5e5e; font-style: italic; } /* CommentVar */
    code span.do { color: #5e5e5e; font-style: italic; } /* Documentation */
    code span.dt { color: #ad0000; } /* DataType */
    code span.dv { color: #ad0000; } /* DecVal */
    code span.er { color: #ad0000; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #ad0000; } /* Float */
    code span.fu { color: #4758ab; } /* Function */
    code span.im { color: #00769e; } /* Import */
    code span.in { color: #5e5e5e; } /* Information */
    code span.kw { color: #003b4f; } /* Keyword */
    code span.op { color: #5e5e5e; } /* Operator */
    code span.ot { color: #003b4f; } /* Other */
    code span.pp { color: #ad0000; } /* Preprocessor */
    code span.sc { color: #5e5e5e; } /* SpecialChar */
    code span.ss { color: #20794d; } /* SpecialString */
    code span.st { color: #20794d; } /* String */
    code span.va { color: #111111; } /* Variable */
    code span.vs { color: #20794d; } /* VerbatimString */
    code span.wa { color: #5e5e5e; font-style: italic; } /* Warning */
  </style>
  <link rel="stylesheet" href="SPE2025_files/libs/revealjs/dist/theme/quarto.css">
  <link href="SPE2025_files/libs/revealjs/plugin/quarto-line-highlight/line-highlight.css" rel="stylesheet">
  <link href="SPE2025_files/libs/revealjs/plugin/reveal-menu/menu.css" rel="stylesheet">
  <link href="SPE2025_files/libs/revealjs/plugin/reveal-menu/quarto-menu.css" rel="stylesheet">
  <link href="SPE2025_files/libs/revealjs/plugin/reveal-chalkboard/font-awesome/css/all.css" rel="stylesheet">
  <link href="SPE2025_files/libs/revealjs/plugin/reveal-chalkboard/style.css" rel="stylesheet">
  <link href="SPE2025_files/libs/revealjs/plugin/quarto-support/footer.css" rel="stylesheet">
  <style type="text/css">

  .callout {
    margin-top: 1em;
    margin-bottom: 1em;  
    border-radius: .25rem;
  }

  .callout.callout-style-simple { 
    padding: 0em 0.5em;
    border-left: solid #acacac .3rem;
    border-right: solid 1px silver;
    border-top: solid 1px silver;
    border-bottom: solid 1px silver;
    display: flex;
  }

  .callout.callout-style-default {
    border-left: solid #acacac .3rem;
    border-right: solid 1px silver;
    border-top: solid 1px silver;
    border-bottom: solid 1px silver;
  }

  .callout .callout-body-container {
    flex-grow: 1;
  }

  .callout.callout-style-simple .callout-body {
    font-size: 1rem;
    font-weight: 400;
  }

  .callout.callout-style-default .callout-body {
    font-size: 0.9rem;
    font-weight: 400;
  }

  .callout.callout-titled.callout-style-simple .callout-body {
    margin-top: 0.2em;
  }

  .callout:not(.callout-titled) .callout-body {
      display: flex;
  }

  .callout:not(.no-icon).callout-titled.callout-style-simple .callout-content {
    padding-left: 1.6em;
  }

  .callout.callout-titled .callout-header {
    padding-top: 0.2em;
    margin-bottom: -0.2em;
  }

  .callout.callout-titled .callout-title  p {
    margin-top: 0.5em;
    margin-bottom: 0.5em;
  }
    
  .callout.callout-titled.callout-style-simple .callout-content  p {
    margin-top: 0;
  }

  .callout.callout-titled.callout-style-default .callout-content  p {
    margin-top: 0.7em;
  }

  .callout.callout-style-simple div.callout-title {
    border-bottom: none;
    font-size: .9rem;
    font-weight: 600;
    opacity: 75%;
  }

  .callout.callout-style-default  div.callout-title {
    border-bottom: none;
    font-weight: 600;
    opacity: 85%;
    font-size: 0.9rem;
    padding-left: 0.5em;
    padding-right: 0.5em;
  }

  .callout.callout-style-default div.callout-content {
    padding-left: 0.5em;
    padding-right: 0.5em;
  }

  .callout.callout-style-simple .callout-icon::before {
    height: 1rem;
    width: 1rem;
    display: inline-block;
    content: "";
    background-repeat: no-repeat;
    background-size: 1rem 1rem;
  }

  .callout.callout-style-default .callout-icon::before {
    height: 0.9rem;
    width: 0.9rem;
    display: inline-block;
    content: "";
    background-repeat: no-repeat;
    background-size: 0.9rem 0.9rem;
  }

  .callout-title {
    display: flex
  }
    
  .callout-icon::before {
    margin-top: 1rem;
    padding-right: .5rem;
  }

  .callout.no-icon::before {
    display: none !important;
  }

  .callout.callout-titled .callout-body > .callout-content > :last-child {
    margin-bottom: 0.5rem;
  }

  .callout.callout-titled .callout-icon::before {
    margin-top: .5rem;
    padding-right: .5rem;
  }

  .callout:not(.callout-titled) .callout-icon::before {
    margin-top: 1rem;
    padding-right: .5rem;
  }

  /* Callout Types */

  div.callout-note {
    border-left-color: #4582ec !important;
  }

  div.callout-note .callout-icon::before {
    background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAERlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAA6ABAAMAAAABAAEAAKACAAQAAAABAAAAIKADAAQAAAABAAAAIAAAAACshmLzAAAEU0lEQVRYCcVXTWhcVRQ+586kSUMMxkyaElstCto2SIhitS5Ek8xUKV2poatCcVHtUlFQk8mbaaziwpWgglJwVaquitBOfhQXFlqlzSJpFSpIYyXNjBNiTCck7x2/8/LeNDOZxDuEkgOXe++553zfefee+/OYLOXFk3+1LLrRdiO81yNqZ6K9cG0P3MeFaMIQjXssE8Z1JzLO9ls20MBZX7oG8w9GxB0goaPrW5aNMp1yOZIa7Wv6o2ykpLtmAPs/vrG14Z+6d4jpbSKuhdcSyq9wGMPXjonwmESXrriLzFGOdDBLB8Y6MNYBu0dRokSygMA/mrun8MGFN3behm6VVAwg4WR3i6FvYK1T7MHo9BK7ydH+1uurECoouk5MPRyVSBrBHMYwVobG2aOXM07sWrn5qgB60rc6mcwIDJtQrnrEr44kmy+UO9r0u9O5/YbkS9juQckLed3DyW2XV/qWBBB3ptvI8EUY3I9p/67OW+g967TNr3Sotn3IuVlfMLVnsBwH4fsnebJvyGm5GeIUA3jljERmrv49SizPYuq+z7c2H/jlGC+Ghhupn/hcapqmcudB9jwJ/3jvnvu6vu5lVzF1fXyZuZZ7U8nRmVzytvT+H3kilYvH09mLWrQdwFSsFEsxFVs5fK7A0g8gMZjbif4ACpKbjv7gNGaD8bUrlk8x+KRflttr22JEMRUbTUwwDQScyzPgedQHZT0xnx7ujw2jfVfExwYHwOsDTjLdJ2ebmeQIlJ7neo41s/DrsL3kl+W2lWvAga0tR3zueGr6GL78M3ifH0rGXrBC2aAR8uYcIA5gwV8zIE8onoh8u0Fca/ciF7j1uOzEnqcIm59sEXoGc0+z6+H45V1CvAvHcD7THztu669cnp+L0okAeIc6zjbM/24LgGM1gZk7jnRu1aQWoU9sfUOuhrmtaPIO3YY1KLLWZaEO5TKUbMY5zx8W9UJ6elpLwKXbsaZ4EFl7B4bMtDv0iRipKoDQT2sNQI9b1utXFdYisi+wzZ/ri/1m7QfDgEuvgUUEIJPq3DhX/5DWNqIXDOweC2wvIR90Oq3lDpdMIgD2r0dXvGdsEW5H6x6HLRJYU7C69VefO1x8Gde1ZFSJLfWS1jbCnhtOPxmpfv2LXOA2Xk2tvnwKKPFuZ/oRmwBwqRQDcKNeVQkYcOjtWVBuM/JuYw5b6isojIkYxyYAFn5K7ZBF10fea52y8QltAg6jnMqNHFBmGkQ1j+U43HMi2xMar1Nv0zGsf1s8nUsmUtPOOrbFIR8bHFDMB5zL13Gmr/kGlCkUzedTzzmzsaJXhYawnA3UmARpiYj5ooJZiUoxFRtK3X6pgNPv+IZVPcnwbOl6f+aBaO1CNvPW9n9LmCp01nuSaTRF2YxHqZ8DYQT6WsXT+RD6eUztwYLZ8rM+rcPxamv1VQzFUkzFXvkiVrySGQgJNvXHJAxiU3/NwiC03rSf05VBaPtu/Z7/B8Yn/w7eguloAAAAAElFTkSuQmCC');
  }

  div.callout-note.callout-style-default .callout-title {
    background-color: #dae6fb
  }

  div.callout-important {
    border-left-color: #d9534f !important;
  }

  div.callout-important .callout-icon::before {
    background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAERlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAA6ABAAMAAAABAAEAAKACAAQAAAABAAAAIKADAAQAAAABAAAAIAAAAACshmLzAAAEKklEQVRYCcVXTWhcVRS+575MJym48A+hSRFr00ySRQhURRfd2HYjk2SSTokuBCkU2o0LoSKKraKIBTcuFCoidGFD08nkBzdREbpQ1EDNIv8qSGMFUboImMSZd4/f9zJv8ibJMC8xJQfO3HPPPef7zrvvvnvviIkpC9nsw0UttFunbUhpFzFtarSd6WJkStVMw5xyVqYTvkwfzuf/5FgtkVoB0729j1rjXwThS7Vio+Mo6DNnvLfahoZ+i/o32lULuJ3NNiz7q6+pyAUkJaFF6JwaM2lUJlV0MlnQn5aTRbEu0SEqHUa0A4AdiGuB1kFXRfVyg5d87+Dg4DL6m2TLAub60ilj7A1Ec4odSAc8X95sHh7+ZRPCFo6Fnp7HfU/fBng/hi10CjCnWnJjsxvDNxWw0NfV6Rv5GgP3I3jGWXumdTD/3cbEOP2ZbOZp69yniG3FQ9z1jD7bnBu9Fc2tKGC2q+uAJOQHBDRiZX1x36o7fWBs7J9ownbtO+n0/qWkvW7UPIfc37WgT6ZGR++EOJyeQDSb9UB+DZ1G6DdLDzyS+b/kBCYGsYgJbSQHuThGKRcw5xdeQf8YdNHsc6ePXrlSYMBuSIAFTGAtQo+VuALo4BX83N190NWZWbynBjhOHsmNfFWLeL6v+ynsA58zDvvAC8j5PkbOcXCMg2PZFk3q8MjI7WAG/Dp9AwP7jdGBOOQkAvlFUB+irtm16I1Zw9YBcpGTGXYmk3kQIC/Cds55l+iMI3jqhjAuaoe+am2Jw5GT3Nbz3CkE12NavmzN5+erJW7046n/CH1RO/RVa8lBLozXk9uqykkGAyRXLWlLv5jyp4RFsG5vGVzpDLnIjTWgnRy2Rr+tDKvRc7Y8AyZq10jj8DqXdnIRNtFZb+t/ZRtXcDiVnzpqx8mPcDWxgARUqx0W1QB9MeUZiNrV4qP+Ehc+BpNgATsTX8ozYKL2NtFYAHc84fG7ndxUPr+AR/iQSns7uSUufAymwDOb2+NjK27lEFocm/EE2WpyIy/Hi66MWuMKJn8RvxIcj87IM5Vh9663ziW36kR0HNenXuxmfaD8JC7tfKbrhFr7LiZCrMjrzTeGx+PmkosrkNzW94ObzwocJ7A1HokLolY+AvkTiD/q1H0cN48c5EL8Crkttsa/AXQVDmutfyku0E7jShx49XqV3MFK8IryDhYVbj7Sj2P2eBxwcXoe8T8idsKKPRcnZw1b+slFTubwUwhktrfnAt7J++jwQtLZcm3sr9LQrjRzz6cfMv9aLvgmnAGvpoaGLxM4mAEaLV7iAzQ3oU0IvD5x9ix3yF2RAAuYAOO2f7PEFWCXZ4C9Pb2UsgDeVnFSpbFK7/IWu7TPTvBqzbGdCHOJQSxiEjt6IyZmxQyEJHv6xyQsYk//moVFsN2zP6fRImjfq7/n/wFDguUQFNEwugAAAABJRU5ErkJggg==');
  }

  div.callout-important.callout-style-default .callout-title {
    background-color: #f7dddc
  }

  div.callout-warning {
    border-left-color: #f0ad4e !important;
  }

  div.callout-warning .callout-icon::before {
    background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAERlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAA6ABAAMAAAABAAEAAKACAAQAAAABAAAAIKADAAQAAAABAAAAIAAAAACshmLzAAAETklEQVRYCeVWW2gcVRg+58yaTUnizqbipZeX4uWhBEniBaoUX1Ioze52t7sRq6APio9V9MEaoWlVsFasRq0gltaAPuxms8lu0gcviE/FFOstVbSIxgcv6SU7EZqmdc7v9+9mJtNks51NTUH84ed889/PP+cmxP+d5FIbMJmNbpREu4WUkiTtCicKny0l1pIKmBzovF2S+hIJHX8iEu3hZJ5lNZGqyRrGSIQpq15AzF28jgpeY6yk6GVdrfFqdrD6Iw+QlB8g0YS2g7dyQmXM/IDhBhT0UCiRf59lfqmmDvzRt6kByV/m4JjtzuaujMUM2c5Z2d6JdKrRb3K2q6mA+oYVz8JnDdKPmmNthzkAk/lN63sYPgevrguc72aZX/L9C6x09GYyxBgCX4NlvyGUHOKELlm5rXeR1kchuChJt4SSwyddZRXgvwMGvYo4QSlk3/zkHD8UHxwVJA6zjZZqP8v8kK8OWLnIZtLyCAJagYC4rTGW/9Pqj92N/c+LUaAj27movwbi19tk/whRCIE7Q9vyI6yvRpftAKVTdUjOW40X3h5OXsKCdmFcx0xlLJoSuQngnrJe7Kcjm4OMq9FlC7CMmScQANuNvjfP3PjGXDBaUQmbp296S5L4DrpbrHN1T87ZVEZVCzg1FF0Ft+dKrlLukI+/c9ENo+TvlTDbYFvuKPtQ9+l052rXrgKoWkDAFnvh0wTOmYn8R5f4k/jN/fZiCM1tQx9jQQ4ANhqG4hiL0qIFTGViG9DKB7GYzgubnpofgYRwO+DFjh0Zin2m4b/97EDkXkc+f6xYAPX0KK2I/7fUQuwzuwo/L3AkcjugPNixC8cHf0FyPjWlItmLxWw4Ou9YsQCr5fijMGoD/zpdRy95HRysyXA74MWOnscpO4j2y3HAVisw85hX5+AFBRSHt4ShfLFkIMXTqyKFc46xdzQM6XbAi702a7sy04J0+feReMFKp5q9esYLCqAZYw/k14E/xcLLsFElaornTuJB0svMuJINy8xkIYuL+xPAlWRceH6+HX7THJ0djLUom46zREu7tTkxwmf/FdOZ/sh6Q8qvEAiHpm4PJ4a/doJe0gH1t+aHRgCzOvBvJedEK5OFE5jpm4AGP2a8Dxe3gGJ/pAutug9Gp6he92CsSsWBaEcxGx0FHytmIpuqGkOpldqNYQK8cSoXvd+xLxXADw0kf6UkJNFtdo5MOgaLjiQOQHcn+A6h5NuL2s0qsC2LOM75PcF3yr5STuBSAcGG+meA14K/CI21HcS4LBT6tv0QAh8Dr5l93AhZzG5ZJ4VxAqdZUEl9z7WJ4aN+svMvwHHL21UKTd1mqvChH7/Za5xzXBBKrUcB0TQ+Ulgkfbi/H/YT5EptrGzsEK7tR1B7ln9BBwckYfMiuSqklSznIuoIIOM42MQO+QnduCoFCI0bpkzjCjddHPN/F+2Yu+sd9bKNpVwHhbS3LluK/0zgfwD0xYI5dXuzlQAAAABJRU5ErkJggg==');
  }

  div.callout-warning.callout-style-default .callout-title {
    background-color: #fcefdc
  }

  div.callout-tip {
    border-left-color: #02b875 !important;
  }

  div.callout-tip .callout-icon::before {
    background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAERlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAA6ABAAMAAAABAAEAAKACAAQAAAABAAAAIKADAAQAAAABAAAAIAAAAACshmLzAAADr0lEQVRYCe1XTWgTQRj9ZjZV8a9SPIkKgj8I1bMHsUWrqYLVg4Ue6v9BwZOxSYsIerFao7UiUryIqJcqgtpimhbBXoSCVxUFe9CTiogUrUp2Pt+3aUI2u5vdNh4dmMzOzHvvezuz8xNFM0mjnbXaNu1MvFWRXkXEyE6aYOYJpdW4IXuA4r0fo8qqSMDBU0v1HJUgVieAXxzCsdE/YJTdFcVIZQNMyhruOMJKXYFoLfIfIvVIMWdsrd+Rpd86ZmyzzjJmLStqRn0v8lzkb4rVIXvnpScOJuAn2ACC65FkPzEdEy4TPWRLJ2h7z4cArXzzaOdKlbOvKKX25Wl00jSnrwVxAg3o4dRxhO13RBSdNvH0xSARv3adTXbBdTf64IWO2vH0LT+cv4GR1DJt+DUItaQogeBX/chhbTBxEiZ6gftlDNXTrvT7co4ub5A6gp9HIcHvzTa46OS5fBeP87Qm0fQkr4FsYgVQ7Qg+ZayaDg9jhg1GkWj8RG6lkeSacrrHgDaxdoBiZPg+NXV/KifMuB6//JmYH4CntVEHy/keA6x4h4CU5oFy8GzrBS18cLJMXcljAKB6INjWsRcuZBWVaS3GDrqB7rdapVIeA+isQ57Eev9eCqzqOa81CY05VLd6SamW2wA2H3SiTbnbSxmzfp7WtKZkqy4mdyAlGx7ennghYf8voqp9cLSgKdqNfa6RdRsAAkPwRuJZNbpByn+RrJi1RXTwdi8RQF6ymDwGMAtZ6TVE+4uoKh+MYkcLsT0Hk8eAienbiGdjJHZTpmNjlbFJNKDVAp2fJlYju6IreQxQ08UJDNYdoLSl6AadO+fFuCQqVMB1NJwPm69T04Wv5WhfcWyfXQB+wXRs1pt+nCknRa0LVzSA/2B+a9+zQJadb7IyyV24YAxKp2Jqs3emZTuNnKxsah+uabKbMk7CbTgJx/zIgQYErIeTKRQ9yD9wxVof5YolPHqaWo7TD6tJlh7jQnK5z2n3+fGdggIOx2kaa2YI9QWarc5Ce1ipNWMKeSG4DysFF52KBmTNMmn5HqCFkwy34rDg05gDwgH3bBi+sgFhN/e8QvRn8kbamCOhgrZ9GJhFDgfcMHzFb6BAtjKpFhzTjwv1KCVuxHvCbsSiEz4CANnj84cwHdFXAbAOJ4LTSAawGWFn5tDhLMYz6nWeU2wJfIhmIJBefcd/A5FWQWGgrWzyORZ3Q6HuV+Jf0Bj+BTX69fm1zWgK7By1YTXchFDORywnfQ7GpzOo6S+qECrsx2ifVQAAAABJRU5ErkJggg==');
  }

  div.callout-tip.callout-style-default .callout-title {
    background-color: #ccf1e3
  }

  div.callout-caution {
    border-left-color: #fd7e14 !important;
  }

  div.callout-caution .callout-icon::before {
    background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAERlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAA6ABAAMAAAABAAEAAKACAAQAAAABAAAAIKADAAQAAAABAAAAIAAAAACshmLzAAACV0lEQVRYCdVWzWoUQRCuqp2ICBLJXgITZL1EfQDBW/bkzUMUD7klD+ATSHBEfAIfQO+iXsWDxJsHL96EHAwhgzlkg8nBg25XWb0zIb0zs9muYYWkoKeru+vn664fBqElyZNuyh167NXJ8Ut8McjbmEraKHkd7uAnAFku+VWdb3reSmRV8PKSLfZ0Gjn3a6Xlcq9YGb6tADjn+lUfTXtVmaZ1KwBIvFI11rRXlWlatwIAAv2asaa9mlB9wwygiDX26qaw1yYPzFXg2N1GgG0FMF8Oj+VIx7E/03lHx8UhvYyNZLN7BwSPgekXXLribw7w5/c8EF+DBK5idvDVYtEEwMeYefjjLAdEyQ3M9nfOkgnPTEkYU+sxMq0BxNR6jExrAI31H1rzvLEfRIdgcv1XEdj6QTQAS2wtstEALLG1yEZ3QhH6oDX7ExBSFEkFINXH98NTrme5IOaaA7kIfiu2L8A3qhH9zRbukdCqdsA98TdElyeMe5BI8Rs2xHRIsoTSSVFfCFCWGPn9XHb4cdobRIWABNf0add9jakDjQJpJ1bTXOJXnnRXHRf+dNL1ZV1MBRCXhMbaHqGI1JkKIL7+i8uffuP6wVQAzO7+qVEbF6NbS0LJureYcWXUUhH66nLR5rYmva+2tjRFtojkM2aD76HEGAD3tPtKM309FJg5j/K682ywcWJ3PASCcycH/22u+Bh7Aa0ehM2Fu4z0SAE81HF9RkB21c5bEn4Dzw+/qNOyXr3DCTQDMBOdhi4nAgiFDGCinIa2owCEChUwD8qzd03PG+qdW/4fDzjUMcE1ZpIAAAAASUVORK5CYII=');
  }

  div.callout-caution.callout-style-default .callout-title {
    background-color: #ffe5d0
  }

  </style>
  <style type="text/css">
    .reveal div.sourceCode {
      margin: 0;
      overflow: auto;
    }
    .reveal div.hanging-indent {
      margin-left: 1em;
      text-indent: -1em;
    }
    .reveal .slide:not(.center) {
      height: 100%;
      overflow-y: auto;
    }
    .reveal .slide.scrollable {
      overflow-y: auto;
    }
    .reveal .footnotes {
      height: 100%;
      overflow-y: auto;
    }
    .reveal .slide .absolute {
      position: absolute;
      display: block;
    }
    .reveal .footnotes ol {
      counter-reset: ol;
      list-style-type: none; 
      margin-left: 0;
    }
    .reveal .footnotes ol li:before {
      counter-increment: ol;
      content: counter(ol) ". "; 
    }
    .reveal .footnotes ol li > p:first-child {
      display: inline-block;
    }
    .reveal .slide ul,
    .reveal .slide ol {
      margin-bottom: 0.5em;
    }
    .reveal .slide ul li,
    .reveal .slide ol li {
      margin-top: 0.4em;
      margin-bottom: 0.2em;
    }
    .reveal .slide ul[role="tablist"] li {
      margin-bottom: 0;
    }
    .reveal .slide ul li > *:first-child,
    .reveal .slide ol li > *:first-child {
      margin-block-start: 0;
    }
    .reveal .slide ul li > *:last-child,
    .reveal .slide ol li > *:last-child {
      margin-block-end: 0;
    }
    .reveal .slide .columns:nth-child(3) {
      margin-block-start: 0.8em;
    }
    .reveal blockquote {
      box-shadow: none;
    }
    .reveal .tippy-content>* {
      margin-top: 0.2em;
      margin-bottom: 0.7em;
    }
    .reveal .tippy-content>*:last-child {
      margin-bottom: 0.2em;
    }
    .reveal .slide > img.stretch.quarto-figure-center,
    .reveal .slide > img.r-stretch.quarto-figure-center {
      display: block;
      margin-left: auto;
      margin-right: auto; 
    }
    .reveal .slide > img.stretch.quarto-figure-left,
    .reveal .slide > img.r-stretch.quarto-figure-left  {
      display: block;
      margin-left: 0;
      margin-right: auto; 
    }
    .reveal .slide > img.stretch.quarto-figure-right,
    .reveal .slide > img.r-stretch.quarto-figure-right  {
      display: block;
      margin-left: auto;
      margin-right: 0; 
    }
  </style>
</head>
<body class="quarto-light">
  <div class="reveal">
    <div class="slides">

<section id="title-slide" class="quarto-title-block center">
  <h1 class="title">The Hitchhiker’s Guide to Responsible Machine Learning</h1>
  <p class="subtitle">eXplainable AI with DALEX @ SPE 2025</p>

<div class="quarto-title-authors">
<div class="quarto-title-author">
<div class="quarto-title-author-name">
Przemyslaw Biecek and Nuno Henriques dos Santos de Sepulveda 
</div>
</div>
</div>

  <p class="date">2025-10-22</p>
</section>
<section class="slide level2">

<div class="cell">
<style type="text/css">
.reveal {
  font-size: 24px;
  line-height: 1.6!important;
}
code {
  font-size: 18px!important;
  line-height: 1.2!important;
}
pre {
  line-height: 1.2!important;
}
</style>
</div>

<img data-src="figures/faro.png" class="r-stretch"></section>
<section>
<section id="when-why-what-how-who" class="title-slide slide level1 center">
<h1>When? Why? What? How? Who?</h1>

</section>
<section id="when---agenda" class="slide level2">
<h2>When? - Agenda</h2>
<p>Feel free to interrupt me and ask questions during the workshop!</p>
<ul>
<li><p>9:00 Introduction + Agenda + motivation</p></li>
<li><p>9:15 EDA + Let’s train some models + Evaluate performance</p></li>
<li><p>9:45 XAI pyramid - Permutational Variable Importance</p></li>
<li><p>10:10 <strong>Do it yourself !!!</strong></p></li>
<li><p><em>10:30 BREAK</em></p></li>
<li><p>11:00 XAI pyramid - Break-down and SHAP</p></li>
<li><p>12:00 <strong>Do it yourself !!!</strong></p></li>
<li><p><em>12:30 LUNCH</em></p></li>
<li><p>13:30 XAI pyramid - Ceteris Paribus and Partial Dependence Profile</p></li>
<li><p>14:30 <strong>Do it yourself !!!</strong></p></li>
<li><p>15:00 Closing remarks</p></li>
</ul>
</section>
<section id="why-should-i-care-15" class="slide level2">
<h2>Why should I care? 1/5</h2>

<img data-src="figures/XAI_12.png" class="r-stretch"></section>
<section id="why-should-i-care-25" class="slide level2">
<h2>Why should I care? 2/5</h2>

<img data-src="figures/XAI_11.png" class="r-stretch"></section>
<section id="why-should-i-care-35" class="slide level2">
<h2>Why should I care? 3/5</h2>

<img data-src="figures/XAI_13.png" class="r-stretch"></section>
<section id="why-should-i-care-45" class="slide level2">
<h2>Why should I care? 4/5</h2>
<p>How do we know what the model has learned? Maybe decisions are based on some strange artifact?</p>
<p>This is not a made up possibility, in the example below the model’s decisions correlated strongly with the fact that there were captions in the lower left corner.</p>
<p>It turns out that in the learning data there was often a description in the lower left corner next to the horse pictures. Instead of learning to recognize the characteristics of horses, it is much easier to recognize the presence of text in the lower left corner.</p>
<p>Read more: <a href="https://www.nature.com/articles/s41467-019-08987-4">Unmasking Clever Hans predictors and assessing what machines really learn</a></p>

<img data-src="figures/CleverHans.png" class="r-stretch"></section>
<section id="why-should-i-care-55" class="slide level2">
<h2>Why should I care? 5/5</h2>
<p>There is tremendous potential in Machine Learning, but:</p>
<ul>
<li>there is a growing list of examples in which, despite initial bursts of promise, ML systems did not perform as expected</li>
<li>good results on training data did not transfer to real-world data</li>
<li>systems performed in outright idiotic ways, even though they seemed to work very well during training</li>
<li>more and more people began to cooldown this hurra optimism and collect lists of epic failures of ML</li>
<li>how do we know what the model has learned? Maybe it bases decisions on some strange artifact?</li>
<li>at this point we could discuss various examples of spectacular failures of ML for the next two hours.</li>
</ul>
</section>
<section id="what-13" class="slide level2">
<h2>What? 1/3</h2>
<p><strong>IrResponsible Machine Learning:</strong></p>
<ol type="1">
<li>Select a problem.</li>
<li>Optimize the predictive performance of a model on the test set.</li>
<li>Don’t test anything else.</li>
<li>Jump to another problem.</li>
</ol>
<p><strong>Responsible Machine Learning:</strong></p>
<ol type="1">
<li>Select a problem.</li>
<li>Optimize the predictive performance of a model on the test set.</li>
<li>Verify that the model has not accidentally learned artifacts present in the data.</li>
<li>Verify that it is consistent with domain knowledge.</li>
<li>Monitor the model, because the future is usually different from the training data.</li>
</ol>
</section>
<section id="what-23" class="slide level2">
<h2>What? 2/3</h2>
<p>The purpose of this tutorial is to <strong>present techniques for model exploration, visualisation and explanation</strong>. To do this we will use some interesting real-world data, train a few models on the data and then use <strong>XAI</strong> (eXplainable artificial intelligence) techniques to explore these models. Along the way, we will tackle various interesting topics such as model training, model verification, model visualisation, model comparison and exploratory model analysis.</p>
<p><em>Tools</em></p>
<p>In this tutorial we will work on three types of models, <strong>logistic regression with splines, which is implemented in the <code>rms</code> package, simple decision tree implemented in <code>partykit</code> package and random forest implemented in the <code>ranger</code> package.</strong></p>
<p><strong>Models will be explained and visualized with the <code>DALEX</code> package.</strong> Note that there are also other packages with similar functionalities, for modelling other popular choices are <code>mlr</code>, <code>tidymodels</code> and <code>caret</code> while for the model explanation you will find lots of interesting features in <code>flashlight</code> and <code>iml</code>.</p>
</section>
<section id="what-33" class="slide level2">
<h2>What? 3/3</h2>
<div class="columns">
<div class="column" style="width:67%;">
<p><strong>Literature extending our workshop</strong></p>
<p>The comic book on Responsible Machine Learning.</p>
<ul>
<li>English. <em>The Hitchhiker’s Guide to Responsible Machine Learning.</em> https://betaandbit.github.io/RML/</li>
<li>Portuguese (by Nuno Henriques dos Santos de Sepulveda). <em>O Guia do Mochileiro para o Aprendizado de Máquina Responsável.</em></li>
</ul>
<p>Other books related to the topic of Responsible Machine Learning.</p>
<ul>
<li>Explanatory Model Analysis <a href="https://ema.drwhy.ai/">https://ema.drwhy.ai/</a></li>
<li>Fairness and machine learning <a href="https://fairmlbook.org/">https://fairmlbook.org/</a></li>
<li>An Introduction to Machine Learning Interpretability <a href="https://www.oreilly.com/library/view/an-introduction-to/9781492033158/">https://www.oreilly.com/library/view/an-introduction-to/9781492033158/</a></li>
<li>Interpretable Machine Learning. A Guide for Making Black Box Models Explainable <a href="https://christophm.github.io/interpretable-ml-book/">https://christophm.github.io/interpretable-ml-book/</a></li>
</ul>
</div><div class="column" style="width:33%;">
<p><img data-src="figures/ema2.png"></p>
</div>
</div>
</section>
<section id="how---design-principles" class="slide level2">
<h2>How? - Design Principles</h2>
<ul>
<li><p>The workshop consists of 1/3 lecture, 1/3 code examples discussed by the tutor and 1/3 computer-based exercises for participants.</p></li>
<li><p>It aims to present a set of methods for the exploration of complex predictive models. I assume that participants are familiar with R and have some basic knowledge of predictive models. In this workshop, we will show how to explore these models.</p></li>
<li><p>Feel free to interrupt me and ask questions during the workshop!</p></li>
<li><p>To make working with models more enjoyable, the materials are based on a true story, which we will tell with the help of a comic strips.</p></li>
</ul>
<p><em>The problem</em></p>
<p>The life cycle of a predictive model begins with a well-defined problem. <strong>In this example, we are looking for a model that assesses the risk of death after being diagnosed covid.</strong> We don’t want to guess who will survive and who won’t. We want to construct a score that allows us to sort patients by risk of death.</p>
<p>Why do we need such a model? It could have many applications! Those at higher risk of death could be given more protection, such as providing them with pulse oximeters or preferentially vaccinating them.</p>
</section>
<section class="slide level2">


<img data-src="figures/rml_comic_01.png" class="r-stretch"></section>
<section id="who---lets-get-to-know-each-other-13" class="slide level2">
<h2>Who? - Let’s get to know each other! 1/3</h2>
<div class="columns">
<div class="column" style="width:67%;">
<p><strong>Przemysław Biecek</strong></p>
<ul>
<li>works at <em>Faculty of Mathematics, Informatics, and Mechanics</em> at University of Warsaw and <em>Faculty of Mathematics and Information Science</em> at Warsaw University of Technology, Poland</li>
<li>for 20 years worked with teams of physicians helping them analyze data and build predictive models (often very simple)</li>
<li>research interests include <strong>Responsible Machine Learning</strong> and eXplainable Artificial Intelligence</li>
<li>(also) worked in R&amp;D teams at large and small corporations such as Samsung, IBM, Netezza, Disney, iQuor</li>
<li>leads the work of the MI2.AI research team, which carries out XAI related research projects (<strong>looking for collaborators</strong>)</li>
</ul>
</div><div class="column" style="width:33%;">
<p><img data-src="figures/przemek8.png"></p>
</div>
</div>
</section>
<section id="who---lets-get-to-know-each-other-22" class="slide level2">
<h2>Who? - Let’s get to know each other! 2/2</h2>

<img data-src="figures/menti.png" class="r-stretch"><div class="cell">
<style type="text/css">
.reveal {
  font-size: 24px;
  line-height: 1.6!important;
}
code {
  font-size: 18px!important;
  line-height: 1.2!important;
}
pre {
  line-height: 1.2!important;
}
</style>
</div>
</section>
<section id="model-development-process" class="slide level2">
<h2>Model Development Process</h2>
<p>The model development is an iterative process. In each iteration, new versions of the model are created and then the models are evaluated, conclusions are drawn so as to move to the next iteration.</p>

<img data-src="figures/MDP_washmachine.png" class="r-stretch"></section>
<section id="model-development-process-in-10-steps" class="slide level2">
<h2>Model Development Process in 10 steps</h2>
<p>In this workshop we will go through the process of building a model in ten steps. We will build several candidate models so that they can be compared later using XAI techniques.</p>

<img data-src="figures/RML_process.png" class="r-stretch"></section></section>
<section>
<section id="part-1-introduction-to-predictive-modelling-eda" class="title-slide slide level1 center">
<h1>Part 1: Introduction to predictive modelling + EDA</h1>

</section>
<section id="conception" class="slide level2">
<h2>Conception</h2>
<p>Before we build any model, even before we touch any data we should first determine for what purpose we will build a predictive model.</p>
<p>It is very important to define the objective before we sit down to programming because later it is easy to get lost in setting function parameters and dealing with all these details that we need to do. It is easy to lose sight of the long-term goal.</p>
<p>So, first: Define the objective.</p>
<p>For these exercises, We have selected data on the covid pandemic. Imagine that we want to determine the order of vaccination. In this example, <strong>we want to create a predictive model that assesses individual risks because we would like to rank patients according to their risks.</strong></p>
<p>To get a model that gives the best ranking we will use the AUC measure to evaluate model performance. What exactly the AUC is I’ll talk about a little later, right now the key thing is that we’re interested in ranking patients based on their risk score.</p>
</section>
<section class="slide level2">


<img data-src="figures/rml_comic_03.png" class="r-stretch"></section>
<section id="read-the-data" class="slide level2">
<h2>Read the data</h2>
<p>To build a model we need good data. In Machine Learning, the word <em>good</em> means a large amount of representative data. Collecting representative data is not easy and often requires designing an appropriate experiment.</p>
<p>The best possible scenario is that one can design and run an experiment to collect the necessary data. In less comfortable situations, we look for “natural experiments,” i.e., data that have been collected for another purpose but that can be used to build a model. Here we will use the data= collected through epidemiological interviews. There will be a lot of data points and it should be fairly representative, although unfortunately it only involves symptomatic patients who are tested positive for SARS-COV-2.</p>
<p>For this exercise, we have prepared two sets of characteristics of patients infected with covid. It is important to note that these are not real patient data. This is simulated data, generated to have relationships consistent with real data (obtained from NIH), but the data itself is not real. Fortunately, they are sufficient for our exercise.</p>
<p><strong>The data is divided into two sets <code>covid_spring</code> and <code>covid_summer</code>. The first is acquired in spring 2020 and will be used as training data while the second dataset is acquired in summer and will be used for validation.</strong> In machine learning, model validation is performed on a separate data set. This controls the risk of overfitting an elastic model to the data. If we do not have a separate set then it is generated using cross-validation, out of sample or out of time techniques.</p>
</section>
<section id="read-the-data-1" class="slide level2">
<h2>Read the data</h2>
<ul>
<li><code>covid_spring</code> corresponds to covid mortality data from spring 2020. We will use this data for model training.</li>
<li><code>covid_summer</code> corresponds to covid mortality data from summer 2020. We will use this data for model validation.</li>
</ul>
<p>Both datasets are available in the <code>DALEX</code> package (and in training materials - folder <code>data</code>).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1"></a><span class="fu">library</span>(<span class="st">"DALEX"</span>)</span>
<span id="cb1-2"><a href="#cb1-2"></a><span class="fu">head</span>(covid_spring)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  Gender Age Cardiovascular.Diseases Diabetes Neurological.Diseases
1   Male  29                      No       No                    No
2   Male  50                      No       No                    No
3   Male  39                      No       No                    No
4   Male  40                      No       No                    No
5   Male  53                      No       No                    No
6 Female  36                      No       No                    No
  Kidney.Diseases Cancer Hospitalization Fever Cough Weakness Death
1              No     No              No    No    No       No    No
2              No     No              No   Yes   Yes      Yes    No
3              No     No              No    No    No       No    No
4              No     No              No    No    No       No    No
5              No     No              No   Yes   Yes      Yes    No
6              No     No              No    No    No       No    No</code></pre>
</div>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1"></a><span class="fu">head</span>(covid_summer)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  Gender Age Cardiovascular.Diseases Diabetes Neurological.Diseases
1 Female  57                      No       No                    No
2   Male  34                      No       No                    No
3   Male  73                      No       No                    No
4 Female  48                     Yes       No                    No
5   Male  29                      No       No                    No
6   Male  54                      No       No                    No
  Kidney.Diseases Cancer Hospitalization Fever Cough Weakness Death
1              No     No             Yes   Yes   Yes       No    No
2              No     No              No    No    No       No    No
3              No     No             Yes    No    No       No   Yes
4              No     No              No   Yes    No       No    No
5              No     No             Yes   Yes    No      Yes    No
6              No     No             Yes   Yes   Yes       No    No</code></pre>
</div>
</div>
</section></section>
<section>
<section id="part-2-hello-model" class="title-slide slide level1 center">
<h1>Part 2: Hello model!</h1>

</section>
<section class="slide level2">


<img data-src="figures/rml_comic_05.png" class="r-stretch"></section>
<section id="step-0.-hello-model" class="slide level2">
<h2>Step 0. Hello model!</h2>
<h3 id="sars-cov-2-case-study">SARS-COV-2 case study</h3>
<p>To demonstrate what responsible predictive modelling looks like, we used data obtained in collaboration with the Polish Institute of Hygiene in modelling mortality after the Covid infection. We realize that data on Coronavirus disease can evoke negative feelings. However, it is a good example of how predictive modelling can directly impact our society and how data analysis allows us to deal with complex, important and topical problems.</p>
<p>Our first model will be based on the statistics collected by the <a href="https://www.cdc.gov/">Centers for Disease Control and Prevention (CDC)</a>.</p>

<img data-src="figures/cdc_stats.png" class="r-stretch quarto-figure-center"><p class="caption">Figure&nbsp;1: Mortality statistics as presented on the CDC website accessed on May 2021. This table shows rate ratios compared to the group 5- to 17-year-olds (selected as the reference group because it has accounted for the largest cumulative number of COVID-19 cases compared to other age groups).</p><p><strong>Code snippets:</strong> <a href="https://rml.mi2.ai/00_hello.html#r-snippets">https://rml.mi2.ai/00_hello.html</a></p>
</section>
<section id="step-1.-data-exploration-eda" class="slide level2">
<h2>Step 1. Data Exploration (EDA)</h2>
<h3 id="to-build-a-model-we-need-good-data.">To build a model, we need good data.</h3>
<p>In Machine Learning, the word <em>good</em> means a large amount of representative data. Unfortunately, collecting representative data is neither easy nor cheap and often requires designing and conducting a specific experiment.</p>
<p>Here we use the data collected through epidemiological interviews. The number of interviewed patients is large, so we treat this data as representative, although unfortunately, this data only involves symptomatic patients who are tested positive for SARS-COV-2. Asymptomatic cases are more likely to be young adults.</p>
<p>The data is divided into two sets: <code>covid_spring</code> and <code>covid_summer</code>. The first set was acquired in spring 2020 and will be used as training data, while the second dataset was acquired in the summer and will be used for validation. In machine learning, model validation is performed on a separate data set called validation data. This controls the risk of overfitting an elastic model to the training data. If we do not have a separate set, then it is generated using cross-validation, out-of-sample, out-of-time or similar data splitting techniques.</p>
<p><strong>Code snippets:</strong> <a href="https://rml.mi2.ai/01_eda.html#r-snippets">https://rml.mi2.ai/01_eda.html</a></p>
</section>
<section id="explore-the-data" class="slide level2">
<h2>Explore the data</h2>
<p>Before we start any serious modelling, it is worth looking at the data first. To do this, we will do a simple EDA. In R there are many tools to do data exploration, I value packages that support so-called <em>table one</em>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1"></a><span class="fu">library</span>(<span class="st">"tableone"</span>)</span>
<span id="cb5-2"><a href="#cb5-2"></a>table1 <span class="ot">&lt;-</span> <span class="fu">CreateTableOne</span>(<span class="at">vars =</span> <span class="fu">colnames</span>(covid_spring)[<span class="dv">1</span><span class="sc">:</span><span class="dv">11</span>],</span>
<span id="cb5-3"><a href="#cb5-3"></a>                         <span class="at">data =</span> covid_spring,</span>
<span id="cb5-4"><a href="#cb5-4"></a>                         <span class="at">strata =</span> <span class="st">"Death"</span>)</span>
<span id="cb5-5"><a href="#cb5-5"></a><span class="fu">print</span>(table1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                                   Stratified by Death
                                    No            Yes           p      test
  n                                  9487           513                    
  Gender = Male (%)                  4554 (48.0)    271 (52.8)   0.037     
  Age (mean (SD))                   44.19 (18.32) 74.44 (13.27) &lt;0.001     
  Cardiovascular.Diseases = Yes (%)   839 ( 8.8)    273 (53.2)  &lt;0.001     
  Diabetes = Yes (%)                  260 ( 2.7)     78 (15.2)  &lt;0.001     
  Neurological.Diseases = Yes (%)     127 ( 1.3)     57 (11.1)  &lt;0.001     
  Kidney.Diseases = Yes (%)           111 ( 1.2)     62 (12.1)  &lt;0.001     
  Cancer = Yes (%)                    158 ( 1.7)     68 (13.3)  &lt;0.001     
  Hospitalization = Yes (%)          2344 (24.7)    481 (93.8)  &lt;0.001     
  Fever = Yes (%)                    3314 (34.9)    335 (65.3)  &lt;0.001     
  Cough = Yes (%)                    3062 (32.3)    253 (49.3)  &lt;0.001     
  Weakness = Yes (%)                 2282 (24.1)    196 (38.2)  &lt;0.001     </code></pre>
</div>
</div>
<p>During modelling, the part related to exploration often takes the most time. In this case, we will limit ourselves to some simple graphs.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1"></a><span class="fu">library</span>(<span class="st">"ggplot2"</span>)</span>
<span id="cb7-2"><a href="#cb7-2"></a>old_theme <span class="ot">=</span> <span class="fu">set_theme_dalex</span>(<span class="st">"ema"</span>) </span>
<span id="cb7-3"><a href="#cb7-3"></a></span>
<span id="cb7-4"><a href="#cb7-4"></a><span class="fu">ggplot</span>(covid_spring, <span class="fu">aes</span>(Age)) <span class="sc">+</span></span>
<span id="cb7-5"><a href="#cb7-5"></a>  <span class="fu">geom_histogram</span>() <span class="sc">+</span></span>
<span id="cb7-6"><a href="#cb7-6"></a>  <span class="fu">ggtitle</span>(<span class="st">"Histogram of age"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img data-src="SPE2025_files/figure-revealjs/unnamed-chunk-5-1.png" style="width:70.0%"></p>
</div>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1"></a><span class="fu">ggplot</span>(covid_spring, <span class="fu">aes</span>(Age, <span class="at">fill =</span> Death)) <span class="sc">+</span></span>
<span id="cb8-2"><a href="#cb8-2"></a>  <span class="fu">geom_histogram</span>(<span class="at">color =</span> <span class="st">"white"</span>) <span class="sc">+</span></span>
<span id="cb8-3"><a href="#cb8-3"></a>  <span class="fu">ggtitle</span>(<span class="st">"Histogram of age"</span>) <span class="sc">+</span> </span>
<span id="cb8-4"><a href="#cb8-4"></a>  <span class="fu">scale_fill_manual</span>(<span class="st">""</span>, <span class="at">values =</span> <span class="fu">c</span>(<span class="st">"grey"</span>, <span class="st">"red3"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img data-src="SPE2025_files/figure-revealjs/unnamed-chunk-5-2.png" style="width:70.0%"></p>
</div>
</div>
</section>
<section id="transform-the-data" class="slide level2">
<h2>Transform the data</h2>
<p>One of the most important rules to remember when building a predictive model is:</p>
<p><strong>Do not condition on the future!</strong></p>
<p>Variables like <code>Hospitalization</code> or <code>Cough</code> are not good predictors, because they are not known in advance.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1"></a>covid_spring <span class="ot">&lt;-</span> covid_spring[,<span class="fu">c</span>(<span class="st">"Gender"</span>, <span class="st">"Age"</span>, <span class="st">"Cardiovascular.Diseases"</span>, <span class="st">"Diabetes"</span>,</span>
<span id="cb9-2"><a href="#cb9-2"></a>               <span class="st">"Neurological.Diseases"</span>, <span class="st">"Kidney.Diseases"</span>, <span class="st">"Cancer"</span>,</span>
<span id="cb9-3"><a href="#cb9-3"></a>               <span class="st">"Death"</span>)]</span>
<span id="cb9-4"><a href="#cb9-4"></a>covid_summer <span class="ot">&lt;-</span> covid_summer[,<span class="fu">c</span>(<span class="st">"Gender"</span>, <span class="st">"Age"</span>, <span class="st">"Cardiovascular.Diseases"</span>, <span class="st">"Diabetes"</span>,</span>
<span id="cb9-5"><a href="#cb9-5"></a>               <span class="st">"Neurological.Diseases"</span>, <span class="st">"Kidney.Diseases"</span>, <span class="st">"Cancer"</span>,</span>
<span id="cb9-6"><a href="#cb9-6"></a>               <span class="st">"Death"</span>)]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="python-snippets---data" class="slide level2">
<h2>Python snippets - data</h2>
<p>All files needed to replicate the following code are available at <a href="https://github.com/BetaAndBit/RML">https://github.com/BetaAndBit/RML</a>. Download it and save in the working directory. Let’s start with reading the data.</p>
<h3 id="read-the-data-2">Read the data</h3>
<pre><code>covid_spring = pd.read_csv("py_covid_spring.csv", 
                        delimiter=";")
covid_summer = pd.read_csv("py_covid_summer.csv", 
                        delimiter=";")</code></pre>
<h3 id="exploratory-data-analysis">Exploratory data analysis</h3>
<pre><code>import matplotlib.pyplot as plt
covid_spring.pivot(columns="Death", values="Age").\
        plot.hist(bins=30)
plt.show()

from statsmodels.graphics.mosaicplot import mosaic
mosaic(covid_spring, ['Death', 'Diabetes'])
plt.show()

from tableone import TableOne
columns = ['Gender', 'Age', 'Cardiovascular.Diseases', 'Diabetes',
           'Neurological.Diseases', 'Kidney.Diseases', 'Cancer',
           'Hospitalization', 'Fever', 'Cough', 'Death']
categorical = ['Gender', 'Cardiovascular.Diseases', 'Diabetes',
               'Neurological.Diseases', 'Kidney.Diseases', 'Cancer',
               'Hospitalization', 'Fever', 'Cough']
groupby = ['Death']
TableOne(covid_spring, columns=columns, 
        categorical=categorical, groupby=groupby, limit=1)   </code></pre>
<h3 id="select-subset-of-variables">Select subset of variables</h3>
<pre><code>selected_vars = ['Gender', 'Age', 'Cardiovascular.Diseases', 
        'Diabetes', 'Neurological.Diseases', 'Kidney.Diseases', 
        'Cancer', 'Death']
covid_spring = covid_spring.loc[:, selected_vars]
covid_summer = covid_summer.loc[:, selected_vars]</code></pre>
</section>
<section id="step-2.-model-performance" class="slide level2">
<h2>Step 2. Model Performance</h2>
<p>Note that in the Covid-mortality-risk-assessment problem, we are not interested in the binary prediction survived/dead, but rather in the quality of the ranking of risk scores. Relative risks can be used to do a triage, to determine which people need a response most quickly, such as a vaccine.</p>
<div id="fig-performance_02.png" class="quarto-figure quarto-figure-center">
<figure>
<p><img data-src="figures/performance_02.png"></p>
<figcaption>Figure&nbsp;2: Classical measures of performance for classification tasks - from Wikipedia</figcaption>
</figure>
</div>
<p>For such types of problems, instead of a contingency table, one looks at Receiver Operating Characteristic (ROC) curve, which illustrates the trade-off between the true positive rate (sensitivity) and the false positive rate (1-specificity) at different classification thresholds. The curve’s shape and the area under it (AUC-ROC) provide insights into the classifier’s discrimination ability and overall predictive accuracy.</p>
<div id="fig-roc_cdc" class="quarto-figure quarto-figure-center">
<figure>
<p><img data-src="figures/02_roc_cdc.png"></p>
<figcaption>Figure&nbsp;3: Distribution of scores for the Covid model and the corresponsind ROC curve</figcaption>
</figure>
</div>
<p><strong>Code snippets:</strong> <a href="https://rml.mi2.ai/02_performance.html#r-snippets">https://rml.mi2.ai/02_performance.html</a></p>
</section>
<section id="model-performance" class="slide level2">
<h2>Model performance</h2>
<p>The evaluation of the model performance for the classification is based on different measures than for the regression.</p>
<p>For regression, commonly used measures are Mean squared error MSE</p>
<p><span class="math display">\[MSE(f) = \frac{1}{n} \sum_{i}^{n} (f(x_i) - y_i)^2 \]</span></p>
<p>and Rooted mean squared error RMSE</p>
<p><span class="math display">\[RMSE(f) = \sqrt{MSE(f, X, y)} \]</span></p>
<p>For classification, commonly used measures are Accuracy</p>
<p><span class="math display">\[ACC(f) = (TP + TN)/n\]</span></p>
<p>Precision</p>
<p><span class="math display">\[Prec(f) = TP/(TP + FP)\]</span></p>
<p>and Recall</p>
<p><span class="math display">\[Recall(f) = TP/(TP + FN)\]</span></p>
<p>and F1 score</p>
<p><span class="math display">\[F1(f) = 2\frac{Prec(f)  * Recall(f) }{Prec(f)  + Recall(f)}\]</span></p>
<p>In this problem we are interested in ranking of scores, so we will use the AUC measure (the area under the ROC curve).</p>
<p>There are many measures for evaluating predictive models and they are located in various R packages (<code>ROCR</code>, <code>measures</code>, <code>mlr3measures</code>, etc.). For simplicity, in this example, we use only the AUC measure from the <code>DALEX</code> package.</p>
</section>
<section id="model-performance-1" class="slide level2">
<h2>Model performance</h2>

<img data-src="figures/performance_01.png" class="r-stretch"></section>
<section id="model-performance-2" class="slide level2">
<h2>Model performance</h2>

<img data-src="figures/performance_02.png" class="r-stretch"></section>
<section id="model-performance-3" class="slide level2">
<h2>Model performance</h2>

<img data-src="figures/performance_03.png" class="r-stretch"></section>
<section id="model-performance-4" class="slide level2">
<h2>Model performance</h2>

<img data-src="figures/performance_04.png" class="r-stretch"></section>
<section id="model-performance-5" class="slide level2">
<h2>Model performance</h2>

<img data-src="figures/performance_06.png" class="r-stretch"></section>
<section id="step-3.-grow-a-tree" class="slide level2">
<h2>Step 3. Grow a tree</h2>
<p>There are hundreds of different methods for training machine learning models available to experienced data scientists. One of the oldest and most popular are tree-based algorithms, first introduced in the book <em>Classification And Regression Trees</em> and commonly called CART. Here is the general deescription for this class of algorithms.</p>
<ol type="1">
<li>Start with a single node (root) with a full dataset.</li>
<li>For a current node, find a candidate split for the data in this node. To do this, consider every possible variable, and for each variable, consider every possible cutoff (for a continuous variable) or a subset of levels (for a categorical variable). Select the split that maximizes the measure of separation (see below).</li>
<li>Check a stopping criteria like the minimum gain in node purity or depth of a tree. If the stopping criteria are met, then (obviously) stop. Otherwise, partition the current node into two child nodes and go to step 2 for each child node separately.</li>
</ol>
<p><strong>Code snippets:</strong> <a href="https://rml.mi2.ai/03_tree.html#r-snippets">https://rml.mi2.ai/03_tree.html</a></p>
</section>
<section id="train-tree-based-model" class="slide level2">
<h2>Train tree based model</h2>
<p>In Machine Learning, there are hundreds of algorithms available. Usually, this training boils down to finding parameters for some family of models. One of the most popular families of models is decision trees. Their great advantage is the transparency of their structure.</p>
<p>We will begin building the model by constructing a decision tree. We will stepwise control the complexity of the model.</p>
<p><a href="https://cran.r-project.org/web/packages/partykit/vignettes/ctree.pdf">More info</a></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1"></a><span class="fu">library</span>(<span class="st">"partykit"</span>)</span>
<span id="cb13-2"><a href="#cb13-2"></a></span>
<span id="cb13-3"><a href="#cb13-3"></a>tree1 <span class="ot">&lt;-</span> <span class="fu">ctree</span>(Death <span class="sc">~</span>., covid_spring, </span>
<span id="cb13-4"><a href="#cb13-4"></a>              <span class="at">control =</span> <span class="fu">ctree_control</span>(<span class="at">maxdepth =</span> <span class="dv">1</span>))</span>
<span id="cb13-5"><a href="#cb13-5"></a><span class="fu">plot</span>(tree1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img data-src="SPE2025_files/figure-revealjs/unnamed-chunk-7-1.png" style="width:70.0%"></p>
</div>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1"></a>tree2 <span class="ot">&lt;-</span> <span class="fu">ctree</span>(Death <span class="sc">~</span>., covid_spring, </span>
<span id="cb14-2"><a href="#cb14-2"></a>              <span class="at">control =</span> <span class="fu">ctree_control</span>(<span class="at">maxdepth =</span> <span class="dv">2</span>))</span>
<span id="cb14-3"><a href="#cb14-3"></a><span class="fu">plot</span>(tree2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img data-src="SPE2025_files/figure-revealjs/unnamed-chunk-7-2.png" style="width:70.0%"></p>
</div>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1"></a>tree3 <span class="ot">&lt;-</span> <span class="fu">ctree</span>(Death <span class="sc">~</span>., covid_spring, </span>
<span id="cb15-2"><a href="#cb15-2"></a>              <span class="at">control =</span> <span class="fu">ctree_control</span>(<span class="at">maxdepth =</span> <span class="dv">3</span>))</span>
<span id="cb15-3"><a href="#cb15-3"></a><span class="fu">plot</span>(tree3)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img data-src="SPE2025_files/figure-revealjs/unnamed-chunk-7-3.png" style="width:70.0%"></p>
</div>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1"></a>tree <span class="ot">&lt;-</span> <span class="fu">ctree</span>(Death <span class="sc">~</span>., covid_spring, </span>
<span id="cb16-2"><a href="#cb16-2"></a>              <span class="at">control =</span> <span class="fu">ctree_control</span>(<span class="at">alpha =</span> <span class="fl">0.0001</span>))</span>
<span id="cb16-3"><a href="#cb16-3"></a><span class="fu">plot</span>(tree)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img data-src="SPE2025_files/figure-revealjs/unnamed-chunk-7-4.png" style="width:70.0%"></p>
</div>
</div>
</section>
<section id="python-snippets---toy-model" class="slide level2">
<h2>Python snippets - toy model</h2>
<h3 id="create-a-toy-model">Create a toy model</h3>
<pre><code>import numpy as np
import pandas as pd

class cdc_risk:
    def __init__(self, base_risk = 0.00003):
        self.base_risk = base_risk
        
    def predict(self, x):
        rratio = np.array([7900] * x.shape[0])
        rratio[x.Age &lt; 84.5] = 2800
        rratio[x.Age &lt; 74.5] = 1100
        rratio[x.Age &lt; 64.5] = 400
        rratio[x.Age &lt; 49.5] = 130
        rratio[x.Age &lt; 39.5] = 45
        rratio[x.Age &lt; 29.5] = 15
        rratio[x.Age &lt; 17.5] = 1
        rratio[x.Age &lt; 4.5] = 2
        return rratio * self.base_risk

model_cdc = cdc_risk()
steve = pd.DataFrame({"Age": [25], "Diabetes": ["Yes"]})
model_cdc.predict(steve)
## array([0.00045])</code></pre>
<h3 id="create-an-explainer">Create an explainer</h3>
<p>Calculate performance of the model and plot the ROC curve</p>
<pre><code>explainer_cdc = dx.Explainer(
    model=explainer_cdc, 
    data=covid_summer.drop("Death", axis=1), 
    y=covid_summer.Death, 
    model_type="classification",
    label="cdc"
)

performance_cdc = explainer_cdc.model_performance(cutoff=0.1)
performance_cdc

# ROC curve
performance_cdc.plot(geom="roc")

# LIFT curve
performance_cdc.plot(geom="lift")

import dalex as dx

explainer_cdc = dx.Explainer(model_cdc, label="CDC")
explainer_cdc.predict(steve)
## array([0.00045])</code></pre>
</section>
<section id="python-snippets---tree" class="slide level2">
<h2>Python snippets - tree</h2>
<h3 id="train-a-tree-model">Train a tree model</h3>
<pre><code>from sklearn import tree

model_dtc = tree.DecisionTreeClassifier(max_depth=3, 
        ccp_alpha=0.0001, random_state=0)
model_dtc.fit(covid_spring.drop("Death", axis=1), 
        covid_spring.Death)</code></pre>
<h3 id="plot-it">Plot it</h3>
<pre><code>plt.figure(figsize=(14,7))
_ = tree.plot_tree(
    model_dtc, 
    feature_names=covid_spring.columns,
    fontsize=10
)</code></pre>
<h3 id="create-an-explainer-1">Create an explainer</h3>
<p>Calculate its performance and plot it</p>
<pre><code>explainer_dtc = dx.Explainer(
    model=model_dtc,
    data=covid_summer.drop("Death", axis=1), 
    y=covid_summer.Death, 
    label='dtc'
)

performance_dtc = explainer_dtc.model_performance(
        model_type="classification", cutoff=0.1)
performance_dtc.result

performance_cdc.plot(performance_dtc, geom="roc")</code></pre>
</section>
<section id="step-4.-plant-a-forest" class="slide level2">
<h2>Step 4. Plant a forest</h2>
<p>In 2001, Leo Breiman proposed a new family of models, called random forests, which aggregate decisions from an ensemble of trees trained on bootstrap samples.</p>
<p>Random forests combine two interesting concepts. First, combining multiple weaker models produces a stronger and more stable model. Second, the more diverse the individual models, the greater the benefit of averaging them. To increase the diversity of models, Breiman used the bootstrap technique. Bootstrap is today a very widespread and powerful statistical procedure.</p>

<img data-src="figures/04_randomForest.png" class="r-stretch quarto-figure-center"><p class="caption">Figure&nbsp;4: The key steps are: to generate a set of B bootstrap copies of the dataset by sampling rows with replacement. Deep trees are trained for each copy. During the prediction, the results of the individual trees are aggregated.</p><p><strong>Code snippets:</strong> <a href="https://rml.mi2.ai/04_forest.html#r-snippets">https://rml.mi2.ai/04_forest.html</a></p>
</section>
<section class="slide level2">


<img data-src="figures/rml_comic_06.png" class="r-stretch"></section>
<section id="train-classification-forest" class="slide level2">
<h2>Train classification forest</h2>
<p>Decision trees are models that have low bias but high variance. In 2001, Leo Breiman proposed a new family of models, called a random forest, which averages scores from multiple decision trees trained on bootstrap samples of the data. The whole algorithm is a bit more complex but also very fascinating. You can read about it at <a href="https://tinyurl.com/RF2001">https://tinyurl.com/RF2001</a>. Nowadays a very popular, in a sense complementary technique for improving models is boosting, in which you reduce the model load at the expense of variance. This algorithm reduces variance at the expense of bias. Quite often it leads to a better model.</p>
<p>We will train a random forest with the <code>ranger</code> library.</p>
<p>At this stage we do not dig deep into the model, as we will treat it as a black box.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1"></a><span class="fu">library</span>(<span class="st">"ranger"</span>)</span>
<span id="cb22-2"><a href="#cb22-2"></a></span>
<span id="cb22-3"><a href="#cb22-3"></a>forest <span class="ot">&lt;-</span> <span class="fu">ranger</span>(Death <span class="sc">~</span>., covid_spring, <span class="at">probability =</span> <span class="cn">TRUE</span>)</span>
<span id="cb22-4"><a href="#cb22-4"></a>forest</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Ranger result

Call:
 ranger(Death ~ ., covid_spring, probability = TRUE) 

Type:                             Probability estimation 
Number of trees:                  500 
Sample size:                      10000 
Number of independent variables:  7 
Mtry:                             2 
Target node size:                 10 
Variable importance mode:         none 
Splitrule:                        gini 
OOB prediction error (Brier s.):  0.03709589 </code></pre>
</div>
</div>
</section>
<section id="train-classification-forest---the-mlr3-way" class="slide level2">
<h2>Train classification forest - the mlr3 way</h2>
<p>We will train a random forest with the <code>mlr3</code> library. The first step is to define the prediction task. <a href="https://mlr3book.mlr-org.com/tasks.html">More info</a></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1"></a><span class="fu">library</span>(<span class="st">"mlr3"</span>)</span>
<span id="cb24-2"><a href="#cb24-2"></a><span class="fu">set.seed</span>(<span class="dv">2023</span>)</span>
<span id="cb24-3"><a href="#cb24-3"></a></span>
<span id="cb24-4"><a href="#cb24-4"></a>covid_task <span class="ot">&lt;-</span> TaskClassif<span class="sc">$</span><span class="fu">new</span>(<span class="at">id =</span> <span class="st">"covid_spring"</span>,</span>
<span id="cb24-5"><a href="#cb24-5"></a>                             <span class="at">backend =</span> covid_spring,</span>
<span id="cb24-6"><a href="#cb24-6"></a>                             <span class="at">target =</span> <span class="st">"Death"</span>,</span>
<span id="cb24-7"><a href="#cb24-7"></a>                             <span class="at">positive =</span> <span class="st">"Yes"</span>)</span>
<span id="cb24-8"><a href="#cb24-8"></a>covid_task</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
── &lt;TaskClassif&gt; (10000x8) ─────────────────────────────────────────────────────
• Target: Death
• Target classes: Yes (positive class, 5%), No (95%)
• Properties: twoclass
• Features (7):
  • fct (6): Cancer, Cardiovascular.Diseases, Diabetes, Gender,
  Kidney.Diseases, Neurological.Diseases
  • int (1): Age</code></pre>
</div>
</div>
<p>Now we need to define the family of models in which we want to look for a solution. The random forests is specified by the <code>classif.ranger"</code> parameter. To find the best model in this family we use the <code>train()</code>.</p>
<p><a href="https://mlr3book.mlr-org.com/learners.html">More info</a></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1"></a><span class="fu">library</span>(<span class="st">"mlr3learners"</span>)</span>
<span id="cb26-2"><a href="#cb26-2"></a><span class="fu">library</span>(<span class="st">"ranger"</span>)</span>
<span id="cb26-3"><a href="#cb26-3"></a></span>
<span id="cb26-4"><a href="#cb26-4"></a>covid_ranger <span class="ot">&lt;-</span> <span class="fu">lrn</span>(<span class="st">"classif.ranger"</span>, <span class="at">predict_type =</span> <span class="st">"prob"</span>, <span class="at">num.trees =</span> <span class="dv">25</span>)</span>
<span id="cb26-5"><a href="#cb26-5"></a>covid_ranger</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
── &lt;LearnerClassifRanger&gt; (classif.ranger): Random Forest ──────────────────────
• Model: -
• Parameters: num.threads=1, num.trees=25
• Packages: mlr3, mlr3learners, and ranger
• Predict Types: response and [prob]
• Feature Types: logical, integer, numeric, character, factor, and ordered
• Encapsulation: none (fallback: -)
• Properties: hotstart_backward, importance, missings, multiclass, oob_error,
selected_features, twoclass, and weights
• Other settings: use_weights = 'use'</code></pre>
</div>
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1"></a>covid_ranger<span class="sc">$</span><span class="fu">train</span>(covid_task)</span>
<span id="cb28-2"><a href="#cb28-2"></a>covid_ranger<span class="sc">$</span>model</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Ranger result

Call:
 ranger::ranger(dependent.variable.name = task$target_names, data = task$data(),      probability = self$predict_type == "prob", num.threads = 1L,      num.trees = 25L) 

Type:                             Probability estimation 
Number of trees:                  25 
Sample size:                      10000 
Number of independent variables:  7 
Mtry:                             2 
Target node size:                 10 
Variable importance mode:         none 
Splitrule:                        gini 
OOB prediction error (Brier s.):  0.03731252 </code></pre>
</div>
</div>
</section>
<section id="wrap-the-model" class="slide level2">
<h2>Wrap the model</h2>
<p>In R, we have many tools for creating models. The problem with them is that these tools are created by different people and return results in different structures. So in order to work uniformly with the models we need to package the model in such a way that it has a uniform interface.</p>
<p>Different models have different APIs.</p>
<p><strong>But you need One API to Rule Them All!</strong></p>
<p>The <code>DALEX</code> library provides a unified architecture to explore and validate models using different analytical methods.</p>
<p><a href="http://ema.drwhy.ai/do-it-yourself.html#infoDALEX">More info</a></p>
<p>A trained model can be turned into an explainer. Simpler functions can be used to calculate the performance of this model. But using explainers has an advantage that will be seen in all its beauty in just two pages.</p>
</section>
<section id="wrap-the-model-1" class="slide level2">
<h2>Wrap the model</h2>
<p>To work with different models uniformly, we will also wrap this one into an explainer.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1"></a>model_tree <span class="ot">&lt;-</span>  DALEX<span class="sc">::</span><span class="fu">explain</span>(tree,</span>
<span id="cb30-2"><a href="#cb30-2"></a>                   <span class="at">data =</span> covid_summer[,<span class="sc">-</span><span class="dv">8</span>],</span>
<span id="cb30-3"><a href="#cb30-3"></a>                   <span class="at">y =</span> covid_summer<span class="sc">$</span>Death <span class="sc">==</span> <span class="st">"Yes"</span>,</span>
<span id="cb30-4"><a href="#cb30-4"></a>                   <span class="at">type =</span> <span class="st">"classification"</span>,</span>
<span id="cb30-5"><a href="#cb30-5"></a>                   <span class="at">label =</span> <span class="st">"Tree"</span>,</span>
<span id="cb30-6"><a href="#cb30-6"></a>                   <span class="at">verbose =</span> <span class="cn">FALSE</span>)</span>
<span id="cb30-7"><a href="#cb30-7"></a></span>
<span id="cb30-8"><a href="#cb30-8"></a><span class="fu">predict</span>(model_tree, covid_summer) <span class="sc">|&gt;</span> <span class="fu">head</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>          1           2           3           4           5           6 
0.007781621 0.007781621 0.199029126 0.039772727 0.007781621 0.007781621 </code></pre>
</div>
</div>
<div class="fragment">
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1"></a>model_forest <span class="ot">&lt;-</span>  DALEX<span class="sc">::</span><span class="fu">explain</span>(covid_ranger,</span>
<span id="cb32-2"><a href="#cb32-2"></a>                   <span class="at">predict_function =</span> <span class="cf">function</span>(m,x)</span>
<span id="cb32-3"><a href="#cb32-3"></a>                        <span class="fu">predict</span>(m, x, <span class="at">predict_type =</span> <span class="st">"prob"</span>)[,<span class="dv">1</span>],</span>
<span id="cb32-4"><a href="#cb32-4"></a>                   <span class="at">data =</span> covid_summer[,<span class="sc">-</span><span class="dv">8</span>],</span>
<span id="cb32-5"><a href="#cb32-5"></a>                   <span class="at">y =</span> covid_summer<span class="sc">$</span>Death <span class="sc">==</span> <span class="st">"Yes"</span>,</span>
<span id="cb32-6"><a href="#cb32-6"></a>                   <span class="at">type =</span> <span class="st">"classification"</span>,</span>
<span id="cb32-7"><a href="#cb32-7"></a>                   <span class="at">label =</span> <span class="st">"Forest"</span>,</span>
<span id="cb32-8"><a href="#cb32-8"></a>                   <span class="at">verbose =</span> <span class="cn">FALSE</span>)</span>
<span id="cb32-9"><a href="#cb32-9"></a></span>
<span id="cb32-10"><a href="#cb32-10"></a><span class="fu">predict</span>(model_forest, covid_summer) <span class="sc">|&gt;</span> <span class="fu">head</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.9925268 0.9935949 0.7863655 0.9427417 0.9931352 0.9928162</code></pre>
</div>
</div>
</div>
</section>
<section id="model-performance-6" class="slide level2">
<h2>Model performance</h2>
<p>Model exploration starts with an assessment of how good is the model. The <code>DALEX::model_performance</code> function calculates a set of the most common measures for the specified model.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1"></a>mp_tree <span class="ot">&lt;-</span> <span class="fu">model_performance</span>(model_tree, <span class="at">cutoff =</span> <span class="fl">0.1</span>)</span>
<span id="cb34-2"><a href="#cb34-2"></a>mp_tree</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Measures for:  classification
recall     : 0.8626609 
precision  : 0.1492205 
f1         : 0.2544304 
accuracy   : 0.8822 
auc        : 0.9126477

Residuals:
          0%          10%          20%          30%          40%          50% 
-0.462686567 -0.199029126 -0.007781621 -0.007781621 -0.007781621 -0.007781621 
         60%          70%          80%          90%         100% 
-0.007781621 -0.007781621 -0.007781621 -0.007781621  0.992218379 </code></pre>
</div>
</div>
<div class="fragment">
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1"></a><span class="fu">library</span>(<span class="st">"DALEX"</span>)</span>
<span id="cb36-2"><a href="#cb36-2"></a>mp_forest <span class="ot">&lt;-</span> <span class="fu">model_performance</span>(model_forest, <span class="at">cutoff =</span> <span class="fl">0.1</span>)</span>
<span id="cb36-3"><a href="#cb36-3"></a>mp_forest</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Measures for:  classification
recall     : 0.9012876 
precision  : 0.1516245 
f1         : 0.2595797 
accuracy   : 0.8802 
auc        : 0.9440287

Residuals:
          0%          10%          20%          30%          40%          50% 
-0.659431656 -0.141076524 -0.018505174 -0.007473206 -0.006728635 -0.006405076 
         60%          70%          80%          90%         100% 
-0.006317613 -0.005104816 -0.004902455 -0.004810887  0.995480489 </code></pre>
</div>
</div>
</div>
</section>
<section id="roc-receiver-operating-characteristic-curve" class="slide level2">
<h2>ROC (Receiver Operating characteristic Curve)</h2>
<p>Note: The explainer knows whether the model is for classification or regression, so it automatically selects the right measures. It can be overridden if needed.</p>
<p>The S3 generic <code>plot</code> function draws a graphical summary of the model performance. With the <code>geom</code> argument, one can determine the type of chart.</p>
<p><a href="http://ema.drwhy.ai/modelPerformance.html#fig:exampleROC">More info</a></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1"></a><span class="fu">plot</span>(mp_forest, <span class="at">geom =</span> <span class="st">"roc"</span>) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img data-src="SPE2025_files/figure-revealjs/unnamed-chunk-14-1.png" style="width:70.0%"></p>
</div>
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1"></a><span class="fu">plot</span>(mp_forest, mp_tree, <span class="at">geom =</span> <span class="st">"roc"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img data-src="SPE2025_files/figure-revealjs/unnamed-chunk-14-2.png" style="width:70.0%"></p>
</div>
</div>
<h3 id="lift">LIFT</h3>
<p><a href="http://ema.drwhy.ai/modelPerformance.html#fig:examplePRC">More info</a></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1"></a><span class="fu">plot</span>(mp_forest, <span class="at">geom =</span> <span class="st">"lift"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img data-src="SPE2025_files/figure-revealjs/unnamed-chunk-15-1.png" style="width:70.0%"></p>
</div>
</div>
</section>
<section id="python-snippets---forest" class="slide level2">
<h2>Python snippets - forest</h2>
<h3 id="train-a-forest">Train a forest</h3>
<pre><code>from sklearn.ensemble import RandomForestClassifier

model_rfc = RandomForestClassifier(n_estimators=25, 
        random_state=0)
model_rfc.fit(covid_spring.drop('Death', axis=1),
        covid_spring.Death)</code></pre>
<h3 id="create-an-explainer-2">Create an explainer</h3>
<pre><code>explainer_rfc = dx.Explainer(
    model=model_rfc,
    data=covid_summer.drop('Death', axis=1), 
    y=covid_summer.Death,
    label='rfc'
)</code></pre>
<h3 id="calculate-its-performance-and-plot-it">Calculate its performance and plot it</h3>
<pre><code>performance_rfc = explainer_rfc.model_performance(
        model_type="classification", cutoff=0.1)
performance_rfc.result

performance_cdc.plot([performance_rfc, performance_dtc], 
        geom="roc")</code></pre>
</section>
<section id="step-5.-hyperparameter-optimisation" class="slide level2">
<h2>Step 5. Hyperparameter Optimisation</h2>
<p>Machine Learning algorithms typically have many hyperparameters that specify a model training process. For some model families, like Support Vector Machines (SVM) or Gradient Boosting Machines (GBM), the selection of such hyperparameters has a strong impact on the performance of the final model. The process of finding good hyperparameters is commonly called <em>tuning</em>.</p>
<p>Different model families have different sets of hyperparameters. We don’t always want to optimize all of them simultaneously, so the first step is to define the hyperparameter search space. Once it is specified, then tuning is based on a looped two steps: (1) select a set of hyperparameters and (2) evaluate how good this set of hyperparameters is. These steps are repeated until some stopping criterion is met, such as the maximum number of iterations, or desired minimum model performance.</p>

<img data-src="figures/05_mlr3tuning.png" class="r-stretch quarto-figure-center"><p class="caption">Figure&nbsp;5: The hyperparameter optimization scheme implemented in the mlr3tuning package. Source: https://mlr3book.mlr-org.com/tuning.html</p><p><strong>Code snippets:</strong> <a href="https://rml.mi2.ai/05_hpo.html#r-snippets">https://rml.mi2.ai/05_hpo.html</a></p>
</section>
<section class="slide level2">


<img data-src="figures/rml_comic_07.png" class="r-stretch"></section>
<section id="automated-hyperparameter-optimisation" class="slide level2">
<h2>Automated Hyperparameter Optimisation</h2>
<p>Machine Learning algorithms typically have many hyperparameters that determine how the model is to be trained. For models with high variance, the selection of such hyperparameters has a strong impact on the quality of the final solution. The <a href="https://mlr3book.mlr-org.com/tuning.html">mlr3tuning</a> package contains procedures to automate the process of finding good hyperparameters.</p>
<p>For automatic hyperparameter search, it is necessary to specify a few more elements: (1) a stopping criterion, below it is the number of 10 evaluations, (2) a search strategy for the parameter space, below it is a random search, (3) a way to evaluate the performance of the proposed models, below it is the AUC determined by 5-fold cross-validation.</p>

<img data-src="figures/rml_tuning.png" class="r-stretch"></section>
<section id="automated-hyperparameter-optimisation---define-the-search-space" class="slide level2">
<h2>Automated Hyperparameter Optimisation - define the search space</h2>
<p>In order to be able to automatically search for optimal parameters, it is first necessary to specify what is the space of possible hyperparameters.</p>
<p><a href="https://mlr3book.mlr-org.com/searchspace.html">More info</a></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1"></a><span class="fu">library</span>(<span class="st">"mlr3tuning"</span>)</span>
<span id="cb44-2"><a href="#cb44-2"></a><span class="fu">library</span>(<span class="st">"paradox"</span>)</span>
<span id="cb44-3"><a href="#cb44-3"></a>covid_ranger<span class="sc">$</span>param_set</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;ParamSet(28)&gt;
Key: &lt;id&gt;
                              id    class lower upper nlevels        default
                          &lt;char&gt;   &lt;char&gt; &lt;num&gt; &lt;num&gt;   &lt;num&gt;         &lt;list&gt;
 1:       always.split.variables ParamUty    NA    NA     Inf &lt;NoDefault[0]&gt;
 2:                class.weights ParamUty    NA    NA     Inf         [NULL]
 3:                      holdout ParamLgl    NA    NA       2          FALSE
 4:                   importance ParamFct    NA    NA       4 &lt;NoDefault[0]&gt;
 5:                   keep.inbag ParamLgl    NA    NA       2          FALSE
 6:                    max.depth ParamInt     1   Inf     Inf         [NULL]
 7:                   min.bucket ParamUty    NA    NA     Inf              1
 8:                min.node.size ParamUty    NA    NA     Inf         [NULL]
 9:                         mtry ParamInt     1   Inf     Inf &lt;NoDefault[0]&gt;
10:                   mtry.ratio ParamDbl     0     1     Inf &lt;NoDefault[0]&gt;
11:                    na.action ParamFct    NA    NA       3       na.learn
12:                   node.stats ParamLgl    NA    NA       2          FALSE
13:            num.random.splits ParamInt     1   Inf     Inf              1
14:                  num.threads ParamInt     1   Inf     Inf              1
15:                    num.trees ParamInt     1   Inf     Inf            500
16:                    oob.error ParamLgl    NA    NA       2           TRUE
17:        regularization.factor ParamUty    NA    NA     Inf              1
18:      regularization.usedepth ParamLgl    NA    NA       2          FALSE
19:                      replace ParamLgl    NA    NA       2           TRUE
20:    respect.unordered.factors ParamFct    NA    NA       3 &lt;NoDefault[0]&gt;
21:              sample.fraction ParamDbl     0     1     Inf &lt;NoDefault[0]&gt;
22:                  save.memory ParamLgl    NA    NA       2          FALSE
23: scale.permutation.importance ParamLgl    NA    NA       2          FALSE
24:                         seed ParamInt  -Inf   Inf     Inf         [NULL]
25:         split.select.weights ParamUty    NA    NA     Inf         [NULL]
26:                    splitrule ParamFct    NA    NA       3           gini
27:                      verbose ParamLgl    NA    NA       2           TRUE
28:                 write.forest ParamLgl    NA    NA       2           TRUE
                              id    class lower upper nlevels        default
       parents  value
        &lt;list&gt; &lt;list&gt;
 1:     [NULL] [NULL]
 2:     [NULL] [NULL]
 3:     [NULL] [NULL]
 4:     [NULL] [NULL]
 5:     [NULL] [NULL]
 6:     [NULL] [NULL]
 7:     [NULL] [NULL]
 8:     [NULL] [NULL]
 9:     [NULL] [NULL]
10:     [NULL] [NULL]
11:     [NULL] [NULL]
12:     [NULL] [NULL]
13:  splitrule [NULL]
14:     [NULL]      1
15:     [NULL]     25
16:     [NULL] [NULL]
17:     [NULL] [NULL]
18:     [NULL] [NULL]
19:     [NULL] [NULL]
20:     [NULL] [NULL]
21:     [NULL] [NULL]
22:     [NULL] [NULL]
23: importance [NULL]
24:     [NULL] [NULL]
25:     [NULL] [NULL]
26:     [NULL] [NULL]
27:     [NULL] [NULL]
28:     [NULL] [NULL]
       parents  value</code></pre>
</div>
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1"></a>search_space <span class="ot">=</span> <span class="fu">ps</span>(</span>
<span id="cb46-2"><a href="#cb46-2"></a>  <span class="at">num.trees =</span> <span class="fu">p_int</span>(<span class="at">lower =</span> <span class="dv">50</span>, <span class="at">upper =</span> <span class="dv">500</span>),</span>
<span id="cb46-3"><a href="#cb46-3"></a>  <span class="at">max.depth =</span> <span class="fu">p_int</span>(<span class="at">lower =</span> <span class="dv">1</span>, <span class="at">upper =</span> <span class="dv">10</span>),</span>
<span id="cb46-4"><a href="#cb46-4"></a>  <span class="at">mtry =</span> <span class="fu">p_int</span>(<span class="at">lower =</span> <span class="dv">1</span>, <span class="at">upper =</span> <span class="dv">7</span>),</span>
<span id="cb46-5"><a href="#cb46-5"></a>  <span class="at">splitrule =</span> <span class="fu">p_fct</span>(<span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"gini"</span>, <span class="st">"extratrees"</span>))</span>
<span id="cb46-6"><a href="#cb46-6"></a>)</span>
<span id="cb46-7"><a href="#cb46-7"></a>search_space</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;ParamSet(4)&gt;
          id    class lower upper nlevels        default  value
      &lt;char&gt;   &lt;char&gt; &lt;num&gt; &lt;num&gt;   &lt;num&gt;         &lt;list&gt; &lt;list&gt;
1: num.trees ParamInt    50   500     451 &lt;NoDefault[0]&gt; [NULL]
2: max.depth ParamInt     1    10      10 &lt;NoDefault[0]&gt; [NULL]
3:      mtry ParamInt     1     7       7 &lt;NoDefault[0]&gt; [NULL]
4: splitrule ParamFct    NA    NA       2 &lt;NoDefault[0]&gt; [NULL]</code></pre>
</div>
</div>
</section>
<section id="automated-hyperparameter-optimisation---set-up-the-tuner" class="slide level2">
<h2>Automated Hyperparameter Optimisation - set-up the tuner</h2>
<p>Popular searching strategies are <code>random_search</code> and <code>grid_search</code>. Termination is set fo a specific number of evaluations. Internal testing is based on 5-fold CV.</p>
<p><a href="https://mlr3book.mlr-org.com/tuning.html#autotuner">More info</a></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1"></a>tuned_ranger <span class="ot">=</span> AutoTuner<span class="sc">$</span><span class="fu">new</span>(</span>
<span id="cb48-2"><a href="#cb48-2"></a>  <span class="at">learner    =</span> covid_ranger,</span>
<span id="cb48-3"><a href="#cb48-3"></a>  <span class="at">resampling =</span> <span class="fu">rsmp</span>(<span class="st">"cv"</span>, <span class="at">folds =</span> <span class="dv">5</span>),</span>
<span id="cb48-4"><a href="#cb48-4"></a>  <span class="at">measure    =</span> <span class="fu">msr</span>(<span class="st">"classif.auc"</span>),</span>
<span id="cb48-5"><a href="#cb48-5"></a>  <span class="at">search_space =</span> search_space,</span>
<span id="cb48-6"><a href="#cb48-6"></a>  <span class="at">terminator =</span> <span class="fu">trm</span>(<span class="st">"evals"</span>, <span class="at">n_evals =</span> <span class="dv">10</span>),</span>
<span id="cb48-7"><a href="#cb48-7"></a>  <span class="at">tuner    =</span> <span class="fu">tnr</span>(<span class="st">"random_search"</span>)</span>
<span id="cb48-8"><a href="#cb48-8"></a>)</span>
<span id="cb48-9"><a href="#cb48-9"></a>tuned_ranger</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
── &lt;AutoTuner&gt; (classif.ranger.tuned) ──────────────────────────────────────────
• Model: -
• Parameters: list()
• Packages: mlr3, mlr3tuning, mlr3learners, and ranger
• Predict Types: response and [prob]
• Feature Types: logical, integer, numeric, character, factor, and ordered
• Encapsulation: none (fallback: -)
• Properties: hotstart_backward, importance, missings, multiclass, oob_error,
selected_features, twoclass, and weights
• Other settings: use_weights = 'use'
• Search Space:
          id    class lower upper nlevels
      &lt;char&gt;   &lt;char&gt; &lt;num&gt; &lt;num&gt;   &lt;num&gt;
1: num.trees ParamInt    50   500     451
2: max.depth ParamInt     1    10      10
3:      mtry ParamInt     1     7       7
4: splitrule ParamFct    NA    NA       2</code></pre>
</div>
</div>
</section>
<section id="automated-hyperparameter-optimisation---tune" class="slide level2">
<h2>Automated Hyperparameter Optimisation - tune</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1"></a>tuned_ranger<span class="sc">$</span><span class="fu">train</span>(covid_task)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1"></a>tuned_ranger<span class="sc">$</span>tuning_result</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   num.trees max.depth  mtry splitrule learner_param_vals  x_domain classif.auc
       &lt;int&gt;     &lt;int&gt; &lt;int&gt;    &lt;char&gt;             &lt;list&gt;    &lt;list&gt;       &lt;num&gt;
1:       469         4     2      gini          &lt;list[5]&gt; &lt;list[4]&gt;   0.9277271</code></pre>
</div>
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1"></a>tuned_ranger<span class="sc">$</span><span class="fu">predict_newdata</span>(<span class="at">newdata =</span> covid_spring)<span class="sc">$</span>prob[<span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>,]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>            No        Yes
[1,] 0.9874722 0.01252776
[2,] 0.9874529 0.01254715
[3,] 0.9874722 0.01252776
[4,] 0.9874722 0.01252776</code></pre>
</div>
</div>
</section>
<section id="automated-hyperparameter-optimisation---test-your-model-12" class="slide level2">
<h2>Automated Hyperparameter Optimisation - test your model 1/2</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1"></a>model_tuned <span class="ot">&lt;-</span>  <span class="fu">explain</span>(tuned_ranger,</span>
<span id="cb55-2"><a href="#cb55-2"></a>                           <span class="at">predict_function =</span> <span class="cf">function</span>(m,x)</span>
<span id="cb55-3"><a href="#cb55-3"></a>                               m<span class="sc">$</span><span class="fu">predict_newdata</span>(<span class="at">newdata =</span> x)<span class="sc">$</span>prob[,<span class="dv">1</span>],</span>
<span id="cb55-4"><a href="#cb55-4"></a>                           <span class="at">data =</span> covid_summer[,<span class="sc">-</span><span class="dv">8</span>],</span>
<span id="cb55-5"><a href="#cb55-5"></a>                           <span class="at">y =</span> covid_summer<span class="sc">$</span>Death <span class="sc">==</span> <span class="st">"Yes"</span>,</span>
<span id="cb55-6"><a href="#cb55-6"></a>                           <span class="at">type =</span> <span class="st">"classification"</span>,</span>
<span id="cb55-7"><a href="#cb55-7"></a>                           <span class="at">label =</span> <span class="st">"AutoTune"</span>,</span>
<span id="cb55-8"><a href="#cb55-8"></a>                           <span class="at">verbose =</span> <span class="cn">FALSE</span>)</span>
<span id="cb55-9"><a href="#cb55-9"></a></span>
<span id="cb55-10"><a href="#cb55-10"></a>mp_tuned <span class="ot">&lt;-</span> <span class="fu">model_performance</span>(model_tuned, <span class="at">cutoff =</span> <span class="fl">0.1</span>)</span>
<span id="cb55-11"><a href="#cb55-11"></a>mp_tuned</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Measures for:  classification
recall     : 0.9012876 
precision  : 0.1519537 
f1         : 0.2600619 
accuracy   : 0.8805 
auc        : 0.9449122

Residuals:
         0%         10%         20%         30%         40%         50% 
-0.47222660 -0.14010898 -0.01767580 -0.01266841 -0.01252776 -0.01252776 
        60%         70%         80%         90%        100% 
-0.01249779 -0.01097021 -0.01097021 -0.01095479  0.98902979 </code></pre>
</div>
</div>
</section>
<section id="automated-hyperparameter-optimisation---test-your-model-22" class="slide level2">
<h2>Automated Hyperparameter Optimisation - test your model 2/2</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1"></a><span class="fu">plot</span>(mp_forest, mp_tree, mp_tuned, <span class="at">geom =</span> <span class="st">"roc"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>

</div>
<img data-src="SPE2025_files/figure-revealjs/unnamed-chunk-21-1.png" style="width:70.0%" class="r-stretch"></section>
<section id="fit-logistic-regression-with-splines" class="slide level2">
<h2>Fit logistic regression with splines</h2>
<p>For classification problems, the first choice model is often logistic regression, which in R is implemented in the <code>glm</code> function. In this exercise, we will use a more extended version of logistic regression, in which transformations using splines are allowed. This will allow us to take into account also non-linear relationships between the indicated variable and the model target. Later, exploring the model, we will look at what relationship is learned by logistic regression with splines.</p>
<p>We will train a logistic regression with splines with the <code>rms</code> library. <code>rcs</code> stands for linear tail-restricted cubic spline function.</p>
<p>At this stage we do not dig deep into the model, as we will treat it as a black box.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1"></a><span class="fu">library</span>(<span class="st">"rms"</span>)</span>
<span id="cb58-2"><a href="#cb58-2"></a>lmr_rcs <span class="ot">&lt;-</span> <span class="fu">lrm</span>(Death <span class="sc">~</span> Gender <span class="sc">+</span> <span class="fu">rcs</span>(Age, <span class="dv">3</span>) <span class="sc">+</span> Cardiovascular.Diseases <span class="sc">+</span> Diabetes <span class="sc">+</span></span>
<span id="cb58-3"><a href="#cb58-3"></a>                 Neurological.Diseases <span class="sc">+</span> Kidney.Diseases <span class="sc">+</span> Cancer, covid_spring)</span>
<span id="cb58-4"><a href="#cb58-4"></a>lmr_rcs</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Logistic Regression Model

lrm(formula = Death ~ Gender + rcs(Age, 3) + Cardiovascular.Diseases + 
    Diabetes + Neurological.Diseases + Kidney.Diseases + Cancer, 
    data = covid_spring)

                       Model Likelihood      Discrimination    Rank Discrim.    
                             Ratio Test             Indexes          Indexes    
Obs         10000    LR chi2    1495.41      R2       0.417    C       0.925    
 No          9487    d.f.             8    R2(8,10000)0.138    Dxy     0.849    
 Yes          513    Pr(&gt; chi2) &lt;0.0001     R2(8,1460)0.639    gamma   0.850    
max |deriv| 0.005                            Brier    0.037    tau-a   0.083    

                            Coef    S.E.   Wald Z Pr(&gt;|Z|)
Intercept                   -9.0107 0.9465 -9.52  &lt;0.0001 
Gender=Male                  0.6870 0.1094  6.28  &lt;0.0001 
Age                          0.0872 0.0221  3.94  &lt;0.0001 
Age'                         0.0027 0.0170  0.16  0.8749  
Cardiovascular.Diseases=Yes  0.7746 0.1185  6.54  &lt;0.0001 
Diabetes=Yes                 0.1291 0.1687  0.77  0.4441  
Neurological.Diseases=Yes    0.4927 0.1998  2.47  0.0137  
Kidney.Diseases=Yes          1.1614 0.2022  5.74  &lt;0.0001 
Cancer=Yes                   1.4454 0.1832  7.89  &lt;0.0001 </code></pre>
</div>
</div>
</section>
<section id="fit-logistic-regression-with-splines---test-your-model" class="slide level2">
<h2>Fit logistic regression with splines - test your model</h2>
<p>Wrap the lmr <code>model</code> into a DALEX explainer</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1"></a>model_lmr_rcs <span class="ot">&lt;-</span>  DALEX<span class="sc">::</span><span class="fu">explain</span>(lmr_rcs,</span>
<span id="cb60-2"><a href="#cb60-2"></a>                   <span class="at">data =</span> covid_summer[,<span class="sc">-</span><span class="dv">8</span>],</span>
<span id="cb60-3"><a href="#cb60-3"></a>                   <span class="at">y =</span> covid_summer<span class="sc">$</span>Death <span class="sc">==</span> <span class="st">"Yes"</span>,</span>
<span id="cb60-4"><a href="#cb60-4"></a>                   <span class="at">type =</span> <span class="st">"classification"</span>,</span>
<span id="cb60-5"><a href="#cb60-5"></a>                   <span class="at">label =</span> <span class="st">"LMR"</span>,</span>
<span id="cb60-6"><a href="#cb60-6"></a>                   <span class="at">verbose =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>And calculate the performance</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1"></a>mp_lrm <span class="ot">&lt;-</span> <span class="fu">model_performance</span>(model_lmr_rcs, <span class="at">cutoff =</span> <span class="fl">0.1</span>)</span>
<span id="cb61-2"><a href="#cb61-2"></a>mp_lrm</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Measures for:  classification
recall     : 0.8454936 
precision  : 0.1849765 
f1         : 0.3035439 
accuracy   : 0.9096 
auc        : 0.9413383

Residuals:
           0%           10%           20%           30%           40% 
-0.9428013172 -0.0828083761 -0.0335257237 -0.0174629404 -0.0103056658 
          50%           60%           70%           80%           90% 
-0.0066507046 -0.0042978321 -0.0027801308 -0.0015117688 -0.0005860675 
         100% 
 0.9965505407 </code></pre>
</div>
</div>
</section>
<section id="summarise-all-four-models-together" class="slide level2">
<h2>Summarise all four models together</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1"></a><span class="fu">plot</span>(mp_forest, mp_tree, mp_tuned, mp_lrm, <span class="at">geom =</span> <span class="st">"roc"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>

</div>
<img data-src="SPE2025_files/figure-revealjs/unnamed-chunk-25-1.png" style="width:70.0%" class="r-stretch"><div class="cell">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1"></a><span class="fu">do.call</span>(rbind, <span class="fu">list</span>(<span class="at">tree  =</span> mp_tree<span class="sc">$</span>measures,</span>
<span id="cb64-2"><a href="#cb64-2"></a>                    <span class="at">lrm    =</span> mp_lrm<span class="sc">$</span>measures,</span>
<span id="cb64-3"><a href="#cb64-3"></a>                    <span class="at">forest =</span> mp_forest<span class="sc">$</span>measures,</span>
<span id="cb64-4"><a href="#cb64-4"></a>                    <span class="at">tuned  =</span> mp_tuned<span class="sc">$</span>measures))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>       recall    precision f1        accuracy auc      
tree   0.8626609 0.1492205 0.2544304 0.8822   0.9126477
lrm    0.8454936 0.1849765 0.3035439 0.9096   0.9413383
forest 0.9012876 0.1516245 0.2595797 0.8802   0.9440287
tuned  0.9012876 0.1519537 0.2600619 0.8805   0.9449122</code></pre>
</div>
</div>
</section>
<section id="python-snippets---hyperparameters" class="slide level2">
<h2>Python snippets - hyperparameters</h2>
<h3 id="define-the-search-space-for-hyperparameters">Define the search space for hyperparameters</h3>
<pre><code>import scipy
from sklearn.model_selection import RandomizedSearchCV
search_space = {
    'n_estimators': scipy.stats.randint(50,  500),
    'max_depth': scipy.stats.randint(1,  10),
    'criterion': ["gini", "entropy"]
}</code></pre>
<h3 id="tune-hyperparaters">Tune hyperparaters</h3>
<pre><code>model_rfc_tuned = RandomizedSearchCV(
    estimator=RandomForestClassifier(random_state=0), 
    param_distributions=search_space, 
    n_iter=10,
    cv=5,
    scoring="roc_auc",
    refit=True,
    random_state=0
)

model_rfc_tuned.fit(covid_spring.drop('Death', axis=1), 
        covid_spring.Death)
model_rfc_tuned.best_params_
# {'criterion': 'gini', 'max_depth': 6, 'n_estimators': 242}</code></pre>
<h3 id="create-explainer">Create explainer</h3>
<pre><code>explainer_rfc_tuned = dx.Explainer(
    model=model_rfc_tuned,
    data=covid_summer.drop('Death', axis=1), 
    y=covid_summer.Death,
    label='rfc_tuned'
)</code></pre>
<h3 id="calculate-its-performance-and-plot-its-roc-curve">Calculate its performance and plot its ROC curve</h3>
<pre><code>performance_rfc_tuned = explainer_rfc_tuned.model_performance(
        model_type="classification", cutoff=0.1)
performance_rfc_tuned.result

performance_cdc.plot([performance_rfc, performance_dtc, 
        performance_rfc_tuned], geom="roc")</code></pre>
</section></section>
<section>
<section id="part-3-introduction-to-xai" class="title-slide slide level1 center">
<h1>Part 3: Introduction to XAI</h1>

</section>
<section class="slide level2">


<img data-src="figures/rml_comic_08.png" class="r-stretch"></section>
<section class="slide level2">


<img data-src="figures/DALEXpiramide%202.png" class="r-stretch"></section>
<section id="do-we-need-a-new-measure-for-variable-importance" class="slide level2">
<h2>Do we need a new measure for Variable Importance?</h2>
<p>Some models have built-in methods for the assessment of Variable importance. For linear models, one can use standardized model coefficients or p-values. For random forest one can use out-of-bag classification error. For tree boosting models, one can use gain statistics.</p>
<p>From: <a href="http://www.jmlr.org/papers/volume20/18-760/18-760.pdf">http://www.jmlr.org/papers/volume20/18-760/18-760.pdf</a></p>
<p><em>Several common approaches for variable selection, or for describing relationships between variables, do not necessarily capture a variable’s importance. Null hypothesis testing methods may identify a relationship, but do <strong>not describe the relationship’s strength</strong>. Similarly, checking whether a variable is included by a sparse model-fitting algorithm, such as the Lasso (Hastie et al., 2009), <strong>does not describe the extent to which the variable is relied on.</strong> Partial dependence plots (Breiman et al., 2001; Hastie et al., 2009) <strong>can be difficult to interpret if multiple variables are of interest, or if the prediction model contains interaction effects</strong> .</em></p>
<p><em>Another common VI procedure is to run a model-fitting algorithm twice, first on all of the data, and then again after removing X1 from the data set. The losses for the <strong>two resulting models are then compared to determine the importance, or “necessity,” of X1</strong> (Gevrey et al., 2003). Because this measure is a function of two prediction models rather than one, it does not measure how much either individual model relies on X1.</em></p>
</section>
<section id="variable-importance---model-level-analysis" class="slide level2">
<h2>Variable Importance - Model level analysis</h2>
<p>The procedure described below is universal, model agnostic and does not depend on the model structure.</p>
<p>The procedure is based on variable perturbations in the validation data. If a variable is important in a model, then after its permutation the model predictions should be less accurate.</p>
<p>The permutation-based variable-importance of a variable <span class="math inline">\(i\)</span> is the difference/ratio between the model performance for the original data and the model performance measured on data with the permutated variable <span class="math inline">\(i\)</span></p>
<p><span class="math display">\[
VI(i) = Loss\ f\ under\ noise - Loss\ f\ without\ noise.
\]</span></p>
<p><span class="math display">\[
VI(i) = L(f, X^{perm(i)}, y) - L(f, X, y)
\]</span></p>
<p>where <span class="math inline">\(L(f, X, y)\)</span> is the value of loss function for original data <span class="math inline">\(X\)</span>, true labels <span class="math inline">\(y\)</span> and model <span class="math inline">\(f\)</span>, while <span class="math inline">\(X^{perm(i)}\)</span> is dataset <span class="math inline">\(x\)</span> with <span class="math inline">\(i\)</span>-th variable permuted.</p>
<p>Read more: <a href="https://arxiv.org/abs/1801.01489v1">All Models are Wrong, but Many are Useful: Learning a Variable’s Importance by Studying an Entire Class of Prediction Models Simultaneously</a> by Aaron Fisher, Cynthia Rudin and Francesca Dominici.</p>
</section>
<section id="variable-importance" class="slide level2">
<h2>Variable Importance</h2>
<p>Which performance measure should you choose? It’s up to you. In the <code>DALEX</code> library, by default, RMSE is used for regression and 1-AUC for classification problems. But you can change the loss function by specifying the argument.</p>
<p><a href="http://ema.drwhy.ai/featureImportance.html">More info</a></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1"></a>mpart_forest <span class="ot">&lt;-</span> <span class="fu">model_parts</span>(model_forest)</span>
<span id="cb70-2"><a href="#cb70-2"></a>mpart_forest</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                 variable mean_dropout_loss  label
1            _full_model_        0.05498022 Forest
2   Neurological.Diseases        0.05626622 Forest
3         Kidney.Diseases        0.05992055 Forest
4                  Gender        0.06010790 Forest
5                Diabetes        0.06060290 Forest
6                  Cancer        0.06460837 Forest
7 Cardiovascular.Diseases        0.08003602 Forest
8                     Age        0.19641857 Forest
9              _baseline_        0.51847955 Forest</code></pre>
</div>
</div>

<img data-src="figures/permute.png" class="r-stretch"></section>
<section id="variable-importance---many-models" class="slide level2">
<h2>Variable Importance - many models</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb72-1"><a href="#cb72-1"></a>mpart_forest <span class="ot">&lt;-</span> <span class="fu">model_parts</span>(model_forest, <span class="at">type =</span> <span class="st">"difference"</span>)</span>
<span id="cb72-2"><a href="#cb72-2"></a>mpart_forest</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                 variable mean_dropout_loss  label
1            _full_model_       0.000000000 Forest
2   Neurological.Diseases       0.001731690 Forest
3                Diabetes       0.003428619 Forest
4                  Gender       0.003456805 Forest
5         Kidney.Diseases       0.004802762 Forest
6                  Cancer       0.009728721 Forest
7 Cardiovascular.Diseases       0.017788699 Forest
8                     Age       0.134556701 Forest
9              _baseline_       0.490905992 Forest</code></pre>
</div>
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb74-1"><a href="#cb74-1"></a><span class="fu">plot</span>(mpart_forest, <span class="at">show_boxplots =</span> <span class="cn">FALSE</span>, <span class="at">bar_width=</span><span class="dv">4</span>) <span class="sc">+</span></span>
<span id="cb74-2"><a href="#cb74-2"></a>  <span class="fu">ggtitle</span>(<span class="st">"Variable importance"</span>,<span class="st">""</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img data-src="SPE2025_files/figure-revealjs/unnamed-chunk-28-1.png" style="width:70.0%"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb75-1"><a href="#cb75-1"></a>mpart_forest  <span class="ot">&lt;-</span> <span class="fu">model_parts</span>(model_forest)</span>
<span id="cb75-2"><a href="#cb75-2"></a>mpart_tree    <span class="ot">&lt;-</span> <span class="fu">model_parts</span>(model_tree)</span>
<span id="cb75-3"><a href="#cb75-3"></a>mpart_tuned   <span class="ot">&lt;-</span> <span class="fu">model_parts</span>(model_tuned)</span>
<span id="cb75-4"><a href="#cb75-4"></a>mpart_lmr_rcs <span class="ot">&lt;-</span> <span class="fu">model_parts</span>(model_lmr_rcs)</span>
<span id="cb75-5"><a href="#cb75-5"></a></span>
<span id="cb75-6"><a href="#cb75-6"></a><span class="fu">plot</span>(mpart_forest, mpart_tree, mpart_lmr_rcs, mpart_tuned, <span class="at">show_boxplots =</span> <span class="cn">FALSE</span>, <span class="at">bar_width=</span><span class="dv">4</span>) <span class="sc">+</span></span>
<span id="cb75-7"><a href="#cb75-7"></a>  <span class="fu">ggtitle</span>(<span class="st">"Variable importance"</span>,<span class="st">""</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img data-src="SPE2025_files/figure-revealjs/unnamed-chunk-29-1.png" style="width:70.0%"></p>
</div>
</div>
</section>
<section id="python-snippets---variable-importance" class="slide level2">
<h2>Python snippets - variable importance</h2>
<h3 id="calculate-variable-importance-for-a-single-model">Calculate variable importance for a single model</h3>
<pre><code>importance_rfc = explainer_rfc.model_parts(loss_function="1-auc", 
        type="difference", random_state=0)
importance_rfc.plot(max_vars=7, show=False)</code></pre>
<h3 id="calculate-variable-importance-for-few-models">Calculate variable importance for few models</h3>
<pre><code>importance_cdc = explainer_cdc.model_parts(loss_function="1-auc",
        type="difference", random_state=0)
importance_dtc = explainer_dtc.model_parts(loss_function="1-auc",
        type="difference", random_state=0)
importance_rfc_tuned = explainer_rfc_tuned.model_parts(
    loss_function="1-auc", type="difference", random_state=0)

importance_cdc.plot([importance_rfc, importance_dtc, 
        importance_rfc_tuned], show=False)</code></pre>
</section>
<section id="your-turn" class="slide level2">
<h2>Your turn</h2>
<ul>
<li>Choose any of the following datasets. You will work with them in the following DIY sessions
<ul>
<li><code>DALEX::covid_summer</code>. The classification task with the target variable <code>Death</code>. <strong>Recommended</strong>. You can replicate examples from the tutorial without any change.</li>
<li><code>kmed::heart</code>. The binary classification task with the target variable <code>class</code> (make it binary with 0 / non 0 split). Most code snippets should work without any change. Read more about the data at <a href="https://archive.ics.uci.edu/ml/datasets/Heart+Disease">https://archive.ics.uci.edu/ml/datasets/Heart+Disease</a></li>
<li><code>survival::lung</code>. Survival task but can be turned to binary classification problem. Target variable <code>status</code>. Read more about this data at <a href="https://r-data.pmagunia.com/dataset/r-dataset-package-survival-cancer">https://r-data.pmagunia.com/dataset/r-dataset-package-survival-cancer</a></li>
</ul></li>
<li>Plot distribution of selected variables and the target variable (optional)</li>
<li>Calculate <code>tableone</code> (optional)</li>
<li>Train random forest model model and logistic regression model for selected data (<code>covid_summer</code>, <code>heart</code>, <code>lung</code>)</li>
<li>Plot ROC</li>
<li>Calculate AUC</li>
<li>Train random forest model, tree based model and regression based models for selected data (<code>covid_summer</code>, <code>heart</code>, <code>lung</code>)</li>
<li>Calculate and plot variable importance for one model.</li>
<li>Compare results for different models.</li>
</ul>
</section>
<section id="your-turn-1" class="slide level2">
<h2>Your turn</h2>
<p>Example for heart data</p>
<pre><code>library("kmed")
head(heart)
heart2 &lt;- kmed::heart
heart2$class &lt;- factor(heart2$class == 0, labels = c("healthy", "disease"))

library(ranger)
forest &lt;- ranger(class ~., data = heart2, probability = TRUE)
forest

library(DALEX)
model_forest &lt;-  DALEX::explain(forest,
                   data = heart2,
                   y = heart2$class == "disease",
                   type = "classification",
                   label = "Ranger",
                   verbose = FALSE)
mp &lt;- model_performance(model_forest)
mp
plot(mp, geom = "roc")


library(rms)
lmr_rcs &lt;- lrm(class ~ ca + rcs(age, 3) + thal + cp + sex, heart2)
lmr_rcs

model_lmr_rcs &lt;-  DALEX::explain(lmr_rcs,
                   data = heart2,
                   y = heart2$class == "disease",
                   type = "classification",
                   label = "LMR",
                   verbose = FALSE)

mp_lrm &lt;- model_performance(model_lmr_rcs)
mp_lrm
plot(mp, mp_lrm, geom = "roc")</code></pre>
</section></section>
<section id="time-for-break" class="title-slide slide level1 center">
<h1>Time for BREAK !!!</h1>
<p>See you in 30 minutes!</p>
<p style="margin-bottom:3cm;">
<b></b>
</p>
</section>

<section>
<section id="part-4-variable-importance---instance-level-analysis" class="title-slide slide level1 center">
<h1>Part 4: Variable Importance - Instance level analysis</h1>

</section>
<section class="slide level2">


<img data-src="figures/rml_comic_10.png" class="r-stretch"></section>
<section class="slide level2">

<p>
<img src="figures/xai_piramide_shap1.png" width="100%">
</p>
</section>
<section id="a-unified-approach-to-interpreting-model-predictions" class="slide level2">
<h2>A Unified Approach to Interpreting Model Predictions</h2>
<ul>
<li>In this course, you will learn about the main methods and tools related to XAI, but also (and this may be unique) about selected papers and researchers.</li>
<li>That’s why we will start this and the next classes with a brief presentation of a high-impact article from the XAI field + few words about the author of this article.</li>
<li>Today we are talking about Shapley values, so the article of the day will be the 2017 SHAP method article.</li>
<li>It will be about the paper <a href="https://papers.nips.cc/paper/2017/hash/8a20a8621978632d76c43dfd28b67767-Abstract.html">A Unified Approach to Interpreting Model Predictions</a></li>
</ul>
<p>
<img src="figures/shap_abstract.png" width="100%">
</p>
</section>
<section id="shap-paper-in-numbers" class="slide level2">
<h2>SHAP paper in numbers</h2>
<ul>
<li>This article is really exceptional, it will soon exceed 10,000 citations which is an amazing achievement.</li>
<li>The article has several strong points, which we will talk about later today, one of which is the available software that allows you to easily use the described method</li>
<li>This software is a shap library, which on GitHub has skyrocketing numbers of stars and downloads</li>
</ul>
<p>
<img src="figures/shap_popular2.png" width="100%">
</p>
<p>
<img src="figures/shap_popular3.png" width="100%">
</p>
</section>
<section id="why-shap" class="slide level2">
<h2>Why SHAP?</h2>
<ul>
<li>Shapley values are currently the most popular technique for model explanations (almost in each category: local, global, model agnostic, model specific…)</li>
<li>if you remember only one method after this course, let it be the SHAP</li>
<li>It has more than five years of development. In the list of major XAI methods, you can also find its various extensions like ShapleyFlow or ASV (more about them later)</li>
<li>figures below are from the paper <a href="https://link.springer.com/chapter/10.1007/978-3-031-04083-2_2">Explainable AI Methods - A Brief Overview</a></li>
</ul>
<p>
<img src="figures/shap_intro1.png" width="100%">
</p>
<p>
<img src="figures/shap_intro2.png" width="100%">
</p>
</section>
<section id="xai-pyramid" class="slide level2">
<h2>XAI pyramid</h2>
<ul>
<li>We will use an XAI pyramid to present new methods during this course.</li>
<li>Today we will mainly talk about the method of local explanations - Shapley values, which for a single observation determines the importance of variables.</li>
</ul>
<p>
<img src="figures/xai_piramide_shap1.png" width="100%">
</p>
</section>
<section id="xai-pyramid-1" class="slide level2">
<h2>XAI pyramid</h2>
<ul>
<li>This is one of the three fundamental methods of explaining the behaviour of predictive models.</li>
<li>The following three panels introduce these three concepts; we will return to them in one week and two weeks.</li>
<li>SHAP corresponds to panel C. We try to explain the behaviour of the model by decomposing the distance between this particular prediction and the average prediction of the model.</li>
</ul>
<p>
<img src="figures/xai_piramide_shap2.png" width="100%">
</p>
</section></section>
<section>
<section id="shapley-values" class="title-slide slide level1 center">
<h1>Shapley values</h1>
<p><br><br><br></p>
</section>
<section id="notation" class="slide level2">
<h2>Notation</h2>
<ul>
<li>We have set of <span class="math inline">\(P = \{1, ..., p\}\)</span> players</li>
<li>For each coalition, i.e.&nbsp;subset <span class="math inline">\(S \subseteq P\)</span> we can calculate the payout <span class="math inline">\(v(S)\)</span> and <span class="math inline">\(v(\{\varnothing\}) = 0\)</span></li>
<li>We want to fairly distribute the payout <span class="math inline">\(v(P)\)</span></li>
<li>Optimal attribution for player <span class="math inline">\(i\in P\)</span> will be denoted as <span class="math inline">\(\phi_i\)</span></li>
</ul>
</section>
<section id="motivational-example-13" class="slide level2">
<h2>Motivational example 1/3</h2>
<p>How to divide the reward?</p>
<ul>
<li>Three parties A, B and C took part in the election.</li>
<li>As a result of the election, parties A and B each have 49% representation in the parliament and party C has 2% representation.</li>
<li>Let’s assume that A and C formed a government.</li>
<li>How to fairly divide the prize (ministries)?</li>
<li>What share of the prize should party C have?</li>
</ul>
<p>Note that any two parties can form a government. In that case, should the prize for C be equal to or less than that for A?</p>
<p>
<img src="figures/shap_v_01.png" width="100%">
</p>
</section>
<section id="motivational-example-23" class="slide level2">
<h2>Motivational example 2/3</h2>
<p>Students A, B and C carry out a project together. With this payoff table, determine what portion of the award each student should get.</p>
<p>
<img src="figures/shap_v_02.png" width="100%">
</p>
</section>
<section id="motivational-example-23-cont." class="slide level2">
<h2>Motivational example 2/3 cont.</h2>
<p>Students A, B and C carry out a project together. With this payoff table, determine what portion of the award each student should get.</p>
<p>
<img src="figures/shap_v_03.png" width="100%">
</p>
</section>
<section id="motivational-example-33" class="slide level2">
<h2>Motivational example 3/3</h2>
<p>Students A, B and C carry out a project together. With this payoff table, determine what portion of the award each student should get.</p>
<p>
<img src="figures/shap_v_04.png" width="100%">
</p>
</section>
<section id="motivational-example-33-cont." class="slide level2">
<h2>Motivational example 3/3 cont.</h2>
<p>Students A, B and C carry out a project together. With this payoff table, determine what portion of the award each student should get.</p>
<p>
<img src="figures/shap_v_05.png" width="100%">
</p>
</section>
<section id="required-properties-of-fair-payout" class="slide level2">
<h2>Required properties of fair payout</h2>
<p>One can define various desirable properties of fair reward distribution. The following seem to be natural (or at least they were for Lord Shapley).</p>
<ul>
<li><strong>Efficiency</strong>: all contributions sum up to the final reward</li>
</ul>
<p><span class="math display">\[
\sum_j \phi_j = v(P)
\]</span></p>
<ul>
<li><strong>Symmetry</strong>: if players <span class="math inline">\(i\)</span> and <span class="math inline">\(j\)</span> contributed in the same way to each coalition then they get the same reward</li>
</ul>
<p><span class="math display">\[
\forall_S v(S \cup \{i\}) = v(S \cup \{j\})     \Rightarrow \phi_i = \phi_j
\]</span></p>
<ul>
<li><strong>Dummy</strong>: if player <span class="math inline">\(i\)</span> does not contribute then its reward is <span class="math inline">\(0\)</span></li>
</ul>
<p><span class="math display">\[
\forall_S v(S \cup \{i\}) = v(S)    \Rightarrow \phi_i = 0
\]</span></p>
<ul>
<li><strong>Additivity</strong>: reward in sum of games <span class="math inline">\(v_1\)</span> and <span class="math inline">\(v_2\)</span> is sum of rewards</li>
</ul>
<p><span class="math display">\[
\forall_S v(S) = v_1(S) + v_2(S)    \Rightarrow \phi_i = \phi_{1,i} + \phi_{2,i}
\]</span></p>
</section>
<section id="shapley-values-via-permutations" class="slide level2">
<h2>Shapley values (via permutations)</h2>
<ul>
<li>Fair reward sharing strategy for player <span class="math inline">\(j\in P\)</span> will be denoted as <span class="math inline">\(\phi_j\)</span>. Surprise, these are Shapley values.</li>
<li>Note that added value of player <span class="math inline">\(j\)</span> to coalition <span class="math inline">\(S\)</span> is <span class="math inline">\(v(S \cup \{j\}) - v(S)\)</span></li>
<li>Shapley values are defined as</li>
</ul>
<p><span class="math display">\[
\phi_j = \frac{1}{|P|!} \sum_{\pi \in \Pi} (v(S_j^\pi \cup \{j\}) - v(S_j^\pi))
\]</span></p>
<p>where <span class="math inline">\(\Pi\)</span> is a set of all possible permutations of players <span class="math inline">\(P\)</span> while <span class="math inline">\(S_j^\pi\)</span> is a set of players that are before player <span class="math inline">\(j\)</span> in permutation <span class="math inline">\(\pi\)</span>.</p>
<ul>
<li>Instead of trying all <span class="math inline">\(\Pi\)</span> permutations one can use only <span class="math inline">\(B\)</span> random permutations to estimate <span class="math inline">\(\phi_j\)</span></li>
</ul>
<p><span class="math display">\[
\hat\phi_j = \frac{1}{|B|} \sum_{\pi \in B} (v(S_j^\pi \cup \{j\}) - v(S_j^\pi))
\]</span></p>
</section>
<section id="shapley-values-via-subsets" class="slide level2">
<h2>Shapley values (via subsets)</h2>
<p>
<img src="figures/shap_order.png" width="100%">
</p>
<ul>
<li>Once you have a given set <span class="math inline">\(S_j^\pi\)</span> of players that are before <span class="math inline">\(j\)</span> in a permutation <span class="math inline">\(\pi\)</span>, then the added value of <span class="math inline">\(j\)</span> is the same for all permutations that starts with <span class="math inline">\(S_j^\pi\)</span>. There is <span class="math inline">\((|P| - |S_j^\pi| - 1)!\)</span> of such permutations.</li>
<li>Also the order of players in <span class="math inline">\(S_j^\pi\)</span> does not matter as the added value of <span class="math inline">\(j\)</span> is the same for all permutations of <span class="math inline">\(S_j^\pi\)</span>. There is <span class="math inline">\(|S_j^\pi|!\)</span> of such orders.</li>
<li>Formula for Shapley values can be rewritten in a following way</li>
</ul>
<p><span class="math display">\[
\phi_j = \sum_{S \subseteq P / \{j\}}  \frac{|S|! (|P| - |S| - 1)!}{|P|!} (v(S \cup \{j\}) - v(S))
\]</span></p>
<ul>
<li>The advantage is summing over subsets, of which there are <span class="math inline">\(2^p\)</span> instead of permutations, of which there are <span class="math inline">\(p!\)</span>.</li>
</ul>
</section>
<section id="motivational-example-33-solution" class="slide level2">
<h2>Motivational example 3/3 solution</h2>
<p>Students A, B and C carry out a project together. With this payoff table, determine what portion of the award each student should get.</p>
<p>
<img src="figures/shap_v_05.png" width="100%">
</p>
<ul>
<li>Now we can calculate the Shapley values and they will be a fair distribution of the reward between students A, B and C</li>
</ul>
<p><span class="math display">\[
\phi_{A} = \frac{1}{6} (10*2 + 20 + 10 + 40*2) = 21 \frac 23
\]</span></p>
<p><span class="math display">\[
\phi_{B} = \frac{1}{6} (30*2 + 40 + 10 + 40*2) = 31 \frac 23
\]</span></p>
<p><span class="math display">\[
\phi_{C} = \frac{1}{6} (50*2 + 50 + 30 + 50*2) = 46 \frac 23
\]</span></p>
</section></section>
<section>
<section id="shapley-values-for-machine-learning-models" class="title-slide slide level1 center">
<h1>Shapley values for Machine Learning Models</h1>
<p><br><br><br></p>
</section>
<section id="definitions" class="slide level2">
<h2>Definitions</h2>
<ul>
<li><p>Let’s start with local explanations, focused on single point <span class="math inline">\(x\)</span> and the model prediction <span class="math inline">\(f(x)\)</span>.</p></li>
<li><p>Now instead of players, you can think about variables. We will distribute a reward between variables to recognize their contribution to the model prediction <span class="math inline">\(f(x)\)</span>.</p></li>
<li><p>Reward to be distributed among players:</p></li>
</ul>
<p><span class="math display">\[
f(x) - E f(x)
\]</span></p>
<div class="fragment">
<ul>
<li>Payoff value function for coalition <span class="math inline">\(S\)</span></li>
</ul>
<p><span class="math display">\[
v(S) = f_S(x_S) - E f(x)
\]</span> where <span class="math inline">\(f_S(x_S)\)</span> is the model prediction maginalized over <span class="math inline">\(P/S\)</span> variables, i.e. <span class="math display">\[
f_S(x_S) = \int_{X_{-S}} f(x_S, X_{-S}) dP(X_{-S})
\]</span></p>
</div>
<div class="fragment">
<ul>
<li>Shapley values via permutations</li>
</ul>
<p><span class="math display">\[
\phi_j = \frac{1}{|P|!} \sum_{\pi \in \Pi} v(S_j^\pi \cup \{j\}) - v(S_j^\pi)
\]</span></p>
<p><strong>Note:</strong> <span class="math inline">\(|P|!\)</span> grows quite fast. <span class="math inline">\(10! = 3 628 800\)</span>. Good news: instead of checking all permutations, one can focus on random <span class="math inline">\(M\)</span> permutations. Also calculation of <span class="math inline">\(f_S(x_S)\)</span> may be computationally heavy for large datasets. But it may be approximated on a subset of observations.</p>
</div>
</section>
<section id="how-to-understand-the-value-function" class="slide level2">
<h2>How to understand the value function</h2>
<ul>
<li>Let’s take a look at how the value function works for a set S of players using the Titanic data example and an explanation for the observations age=8, class=1st, fare=72, ….</li>
<li>Let’s consider the process of conditioning the distribution of data on consecutive variables. In the figure below, we start the prediction distribution for all data, this corresponds to a coalition without players.</li>
<li>Then we add the player <code>age</code>, which means conditioning the data with the condition <code>age=8</code>. Implementation-wise, assuming the independence of the variables, this would correspond to replacing the age value in each observation with the value 8.</li>
<li>Next, we add the class variable to the coalition, which means further conditioning the data with the condition <code>class=1st</code>. In the next step, we add fare to the coalition, and so on.</li>
<li>In the last step, once all the players are in the coalition, that is, all the variables, the model’s predictions will reduce to a single point <span class="math inline">\(f(x)\)</span></li>
</ul>
<p>
<img src="figures/xai_bd_1.png" width="100%">
</p>
<ul>
<li>In fact, we are not interested in the distributions of conditional predictions, only in the expected value of these distributions. This is what our value function is.</li>
</ul>
<p>
<img src="figures/xai_bd_2.png" width="100%">
</p>
<ul>
<li>The added value of variable <span class="math inline">\(j\)</span> when added to the coalition <span class="math inline">\(S\)</span> is the change in expected value. In the example below, adding the <code>class</code> variable to a coalition with the <code>age</code> variable increases the reward by <span class="math inline">\(0.086\)</span>.</li>
</ul>
<p>
<img src="figures/xai_bd_3.png" width="100%">
</p>
</section>
<section id="average-of-conditional-contributions" class="slide level2">
<h2>Average of conditional contributions</h2>
<ul>
<li>The Shapley value is the average after all (or a large number) of the orders in which variables are added to the coalition.</li>
<li>For diagnostic purposes, on graphs, we can also highlight the distribution of added values for different coalitions to get information on how much the effect of a given variable is additive, i.e.&nbsp;leads to the same added value regardless of the previous composition of the coalition.</li>
</ul>
<p>
<img src="figures/xai_bd_4.png" width="100%">
</p>
<ul>
<li>Order matters. For a model that allows interactions, it is easy to find an example of a non-additive effect of a variable. How to explain the different effects of the age variable in the figure below?</li>
</ul>
<p>
<img src="figures/xai_bd_5.png" width="100%">
</p>
</section>
<section id="shap-values" class="slide level2">
<h2>SHAP values</h2>
<p><span class="math display">\[
\phi_j = \frac{1}{|P|!} \sum_{\pi \in \Pi} v(S_j^\pi \cup \{j\}) - v(S_j^\pi)
\]</span></p>
<ul>
<li>The <span class="math inline">\(v(S \cup \{j\}) - v(S)\)</span> may be approximated with <span class="math inline">\(\hat f_{S \cup \{j\}}(x^*) - \hat f_S(x^*)\)</span> where</li>
</ul>
<p><span class="math display">\[
\hat f_S(x^*) = \sum_{i=1}^N f(x^*_S, x^i_{-S})
\]</span></p>
<ul>
<li>The exact calculation of Shapley values leads to the formula</li>
</ul>
<p><span class="math display">\[
\phi_j(x^*) = \frac{1}{N |P|!} \sum_{\pi \in \Pi} \sum_{i=1}^{N}  f(x^*_{S^\pi \cup \{j\}}, x^i_{-S^\pi \cup \{j\}}) - f(x^*_{S^\pi}, x^i_{-S^\pi})
\]</span></p>
<ul>
<li><strong>Note:</strong> For estimation, one can use an only subset of permutations from <span class="math inline">\(\Pi\)</span> and a subset of observations <span class="math inline">\(\{1, ..., N\}\)</span>.</li>
</ul>
</section>
<section id="from-local-to-global-feature-importance" class="slide level2">
<h2>From local to global – Feature importance</h2>
<ul>
<li>The SHAP method gives local explanations, i.e.&nbsp;explanations for each single observation. But we can convert them to global explanations by aggregating the explanations for individual observations.</li>
<li>For example, we can assess the validity of a variable by counting the average modulus of SHAP explanations.</li>
<li>Such a measure of the importance of variables does not depend on the model structure and can be used to compare models.</li>
<li>Below is an example for the model trained for Titanic data</li>
</ul>
<p>
<img src="figures/shap_global_3.png" width="100%">
</p>
</section>
<section id="from-local-to-global-summary-plot" class="slide level2">
<h2>From local to global – Summary plot</h2>
<ul>
<li>One of the most useful statistics is a plot summarizing the distribution of Shapley values for the data for each variable.</li>
<li>On the OX axis are presented the Shapley values, in the rows are the variables. The color indicates whether an observation had a high or low value in that variable.</li>
<li>From the graph you can read which variables are important (they have a large spread of points)</li>
<li>You can read what is the relationship between the variable and the Shapley value, whether the color has a monotonic gradation or there are some dependencies</li>
<li>You can read the distribution of Shapley values</li>
</ul>
<p>
<img src="figures/shap_global_2.png" width="100%">
</p>
</section>
<section id="from-local-to-global-dependence-plot" class="slide level2">
<h2>From local to global – Dependence plot</h2>
<ul>
<li>If we plot the Shapley values as functions of the value of the original variable, it is possible to see what kind of relationship exists between this variable and the average result.</li>
<li>This type of plots allows you to choose the transformations of the variable, and better understand the relationship between this variable and the result of the model</li>
</ul>
<p>
<img src="figures/shap_global_4.png" width="100%">
</p>
<ul>
<li>We can additionally color the graph depending on one more variable (in the example below, it is gender) to see if an interaction is present in the model. In this case, the attributes of the model will depend on the value of this additional variable.</li>
</ul>
<p>
<img src="figures/shap_global_5.png" width="100%">
</p>
</section>
<section id="break-down" class="slide level2">
<h2>Break down</h2>
<p>Both break down and Shapley values can be calculated with a <code>predict_parts()</code> function.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb79-1"><a href="#cb79-1"></a>Steve <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">Gender =</span> <span class="fu">factor</span>(<span class="st">"Male"</span>, <span class="fu">c</span>(<span class="st">"Female"</span>, <span class="st">"Male"</span>)),</span>
<span id="cb79-2"><a href="#cb79-2"></a>       <span class="at">Age =</span> <span class="dv">76</span>,</span>
<span id="cb79-3"><a href="#cb79-3"></a>       <span class="at">Cardiovascular.Diseases =</span> <span class="fu">factor</span>(<span class="st">"Yes"</span>, <span class="fu">c</span>(<span class="st">"No"</span>, <span class="st">"Yes"</span>)), </span>
<span id="cb79-4"><a href="#cb79-4"></a>       <span class="at">Diabetes =</span> <span class="fu">factor</span>(<span class="st">"No"</span>, <span class="fu">c</span>(<span class="st">"No"</span>, <span class="st">"Yes"</span>)), </span>
<span id="cb79-5"><a href="#cb79-5"></a>       <span class="at">Neurological.Diseases =</span> <span class="fu">factor</span>(<span class="st">"No"</span>, <span class="fu">c</span>(<span class="st">"No"</span>, <span class="st">"Yes"</span>)), </span>
<span id="cb79-6"><a href="#cb79-6"></a>       <span class="at">Kidney.Diseases =</span> <span class="fu">factor</span>(<span class="st">"No"</span>, <span class="fu">c</span>(<span class="st">"No"</span>, <span class="st">"Yes"</span>)), </span>
<span id="cb79-7"><a href="#cb79-7"></a>       <span class="at">Cancer =</span> <span class="fu">factor</span>(<span class="st">"No"</span>, <span class="fu">c</span>(<span class="st">"No"</span>, <span class="st">"Yes"</span>)))</span>
<span id="cb79-8"><a href="#cb79-8"></a><span class="fu">predict</span>(model_forest, Steve)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      Yes 
0.3235128 </code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb81-1"><a href="#cb81-1"></a>ppart_tree <span class="ot">&lt;-</span> <span class="fu">predict_parts</span>(model_tree, Steve)</span>
<span id="cb81-2"><a href="#cb81-2"></a><span class="fu">plot</span>(ppart_tree)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>

</div>
<img data-src="SPE2025_files/figure-revealjs/unnamed-chunk-31-1.png" style="width:70.0%" class="r-stretch"></section>
<section id="shap" class="slide level2">
<h2>SHAP</h2>
<p>Both break down and Shapley values can be calculated with a <code>predict_parts()</code> function.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb82-1"><a href="#cb82-1"></a>ppart_forest <span class="ot">&lt;-</span> <span class="fu">predict_parts</span>(model_forest, Steve, <span class="at">type =</span> <span class="st">"shap"</span>)</span>
<span id="cb82-2"><a href="#cb82-2"></a><span class="fu">plot</span>(ppart_forest)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img data-src="SPE2025_files/figure-revealjs/unnamed-chunk-32-1.png" style="width:70.0%"></p>
</div>
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb83-1"><a href="#cb83-1"></a>ppart_tree <span class="ot">&lt;-</span> <span class="fu">predict_parts</span>(model_tree, Steve, <span class="at">type =</span> <span class="st">"shap"</span>)</span>
<span id="cb83-2"><a href="#cb83-2"></a><span class="fu">plot</span>(ppart_tree)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img data-src="SPE2025_files/figure-revealjs/unnamed-chunk-32-2.png" style="width:70.0%"></p>
</div>
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb84-1"><a href="#cb84-1"></a>ppart_lmr_rcs <span class="ot">&lt;-</span> <span class="fu">predict_parts</span>(model_lmr_rcs, Steve, <span class="at">type =</span> <span class="st">"shap"</span>)</span>
<span id="cb84-2"><a href="#cb84-2"></a><span class="fu">plot</span>(ppart_lmr_rcs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img data-src="SPE2025_files/figure-revealjs/unnamed-chunk-32-3.png" style="width:70.0%"></p>
</div>
</div>
</section>
<section id="break-down-shap" class="slide level2">
<h2>Break down + SHAP</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb85-1"><a href="#cb85-1"></a>ppart_forest <span class="ot">&lt;-</span> <span class="fu">predict_parts</span>(model_forest, Steve, <span class="at">type =</span> <span class="st">"shap"</span>)</span>
<span id="cb85-2"><a href="#cb85-2"></a>pl1 <span class="ot">&lt;-</span> <span class="fu">plot</span>(ppart_forest) <span class="sc">+</span> <span class="fu">ggtitle</span>(<span class="st">"Shapley values for Ranger"</span>)</span>
<span id="cb85-3"><a href="#cb85-3"></a></span>
<span id="cb85-4"><a href="#cb85-4"></a>ppart_forest <span class="ot">&lt;-</span> <span class="fu">predict_parts</span>(model_forest, Steve)</span>
<span id="cb85-5"><a href="#cb85-5"></a>pl2 <span class="ot">&lt;-</span> <span class="fu">plot</span>(ppart_forest) <span class="sc">+</span> <span class="fu">ggtitle</span>(<span class="st">"Break-down for Ranger"</span>)</span>
<span id="cb85-6"><a href="#cb85-6"></a></span>
<span id="cb85-7"><a href="#cb85-7"></a><span class="fu">library</span>(<span class="st">"patchwork"</span>)</span>
<span id="cb85-8"><a href="#cb85-8"></a>pl1 <span class="sc">+</span> (pl2 <span class="sc">+</span> <span class="fu">scale_y_continuous</span>(<span class="st">"prediction"</span>, <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="fl">0.4</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>

</div>
<img data-src="SPE2025_files/figure-revealjs/unnamed-chunk-33-1.png" style="width:70.0%" class="r-stretch"><p>Other possible values of the <code>type</code> argument are <code>oscillations</code>, <code>shap</code>, <code>break_down</code>, <code>break_down_interactions</code>.</p>
<p>With <code>order</code> one can force a certain sequence of variables.</p>
</section>
<section id="python-snippets---break-down-and-shapley-values" class="slide level2">
<h2>Python snippets - Break down and Shapley values</h2>
<h3 id="create-a-dataframe-object-with-a-single-observation">Create a DataFrame object with a single observation</h3>
<pre><code>Steve = pd.DataFrame({
    "Gender": [1], 
    "Age": [76], 
    "Cardiovascular.Diseases": [1], 
    "Diabetes": [0],
    "Neurological.Diseases": [0],
    "Kidney.Diseases": [0],
    "Cancer": [0]
})

model_rfc_tuned.predict_proba(Steve)
# array([[0.65611756, 0.34388244]])</code></pre>
<h3 id="calculate-break-down-attributions">Calculate Break Down attributions</h3>
<pre><code>breakdown_steve = explainer_rfc_tuned.predict_parts(Steve, 
        type="break_down", random_state=0)
breakdown_steve.plot(show=False)</code></pre>
<h3 id="calculate-shapley-values">Calculate Shapley values</h3>
<pre><code>shap_steve = explainer_rfc_tuned.predict_parts(Steve, 
        type="shap", random_state=0)
shap_steve.plot(show=False)</code></pre>
</section>
<section id="your-turn-2" class="slide level2">
<h2>Your turn</h2>
<ul>
<li>Train random forest model, tree based model and regression based models for selected data (<code>covid_summer</code>, <code>heart</code>, <code>lung</code>)</li>
<li>Choose (or create) a single observation</li>
<li>Calculate and plot Break-down contributions and SHAP contributions for one model.</li>
<li>Compare results for different models.</li>
</ul>
</section></section>
<section id="time-for-break-1" class="title-slide slide level1 center">
<h1>Time for BREAK !!!</h1>
<p>See you in 60 minutes!</p>
<p style="margin-bottom:3cm;">
<b></b>
</p>
</section>

<section>
<section id="part-5-variable-profile---instance-level-analysis" class="title-slide slide level1 center">
<h1>Part 5: Variable profile - Instance level analysis</h1>

</section>
<section class="slide level2">


<img data-src="figures/rml_comic_11.png" class="r-stretch"></section>
<section class="slide level2">

<p>
</p><center>
<img src="figures/XAI_pdp.png" width="80%">
</center>
<p></p>
</section></section>
<section>
<section id="paper-of-the-day" class="title-slide slide level1 center">
<h1>Paper of the day</h1>
<p><br><br><br></p>
</section>
<section id="visualizing-the-effects-of-predictor-variables" class="slide level2">
<h2>Visualizing the effects of predictor variables</h2>
<ul>
<li>Today we will talk about CP, PD, and ALE methods. The last one was introduced in <a href="https://rss.onlinelibrary.wiley.com/doi/abs/10.1111/rssb.12377">Visualizing the effects of predictor variables in black box supervised learning models</a> by Daniel Apley and Jingyu Zhu</li>
</ul>
<p>
</p><center>
<img src="figures/ale_abstract.png" width="80%">
</center>
<p></p>
</section>
<section id="ale-paper-in-numbers" class="slide level2">
<h2>ALE paper in numbers</h2>
<ul>
<li>The ALE paper was published on arXiv since 2016</li>
<li>Now (2022) it has 530 citations, which is a very high number considering it theoretical character</li>
<li>The paper introduced a new ALE method for model explanation but also shown consequences of unrealistic assumptions (like independence) over calculation of explanations. It leads the discussion about trade off between correctness of explanations and complexity of explanations.</li>
</ul>
<p>
<img src="figures/ale_popular.png" width="100%">
</p>
</section>
<section id="xai-pyramid-2" class="slide level2">
<h2>XAI pyramid</h2>
<ul>
<li>Thinking about the XAI pyramid, we will go to the third level of the pyramid, level related to profile explanations.</li>
<li>We will focus on explanations for a single variable but all presented methods may be extended to two or more variables.</li>
</ul>
<p>
</p><center>
<img src="figures/XAI_pdp.png" width="80%">
</center>
<p></p>
</section>
<section id="what-if" class="slide level2">
<h2>What-if?</h2>
<ul>
<li>when explaining anything, one of the most natural questions is: <em>,,what would happen if the input changes’’</em>.</li>
<li>Note that neither LIME nor SHAP do not directly answer this question. They indicate an importance of some variables, but there is no answer of what would happen if a variable increases/decreases.</li>
<li>For high-dimensional models we are not able to keep track of all possible changes, but we can look towards one or two variables.</li>
<li>Here is an example of such local explanations. Continuous variable on the left. Categorical variable on the right.</li>
</ul>
<p>
</p><center>
<img src="figures/profile_age_class.png" width="70%">
</center>
<p></p>
</section></section>
<section>
<section id="ceteris-paribus" class="title-slide slide level1 center">
<h1>Ceteris Paribus</h1>
<p><br><br><br></p>
</section>
<section id="ceteris-paribus-in-action" class="slide level2">
<h2>Ceteris Paribus in action</h2>
<p>Sound like a spell from Harry Potter?</p>
<ul>
<li><p><em>Ceteris paribus</em> is a Latin phrase, meaning ,,all other things being equal’’ or ,,all else unchanged’’, <a href="https://en.wikipedia.org/wiki/Ceteris_paribus">see Wikipedia</a>.</p></li>
<li><p>It is a function defined for model <span class="math inline">\(f\)</span>, observation <span class="math inline">\(x\)</span>, and variable <span class="math inline">\(j\)</span> as:</p></li>
</ul>
<p><span class="math display">\[\begin{equation}
h^{f}_{x,j}(z) = f\left(x_{j|=z}\right),
\end{equation}\]</span></p>
<p>where <span class="math inline">\(x_{j|=z}\)</span> stands for observation <span class="math inline">\(x\)</span> with <span class="math inline">\(j\)</span>-th coordinate replaced by value <span class="math inline">\(z\)</span>.</p>
<ul>
<li><p>The Ceteris Paribus profile is a function that describes how the model response would change if <span class="math inline">\(j\)</span>-th variable will be changed to <span class="math inline">\(z\)</span> while values of all other variables are kept fixed at the values specified by <span class="math inline">\(x\)</span>.</p></li>
<li><p>In the implementation we cannot check all possible z’s, we have to meaningfully select a subset of them, we will come back to this later.</p></li>
<li><p>Note that CP profiles are also commonly referred as <em>Individual Conditional Expectation (ICE) profiles</em>. This is a common name but might be misleading if the model does not predict the expected value.</p></li>
</ul>
</section>
<section id="ceteris-paribus---many-variables" class="slide level2">
<h2>Ceteris Paribus - Many variables</h2>
<ul>
<li>No one wants to check CP profiles for all possible variables (of which there can be hundreds) but only for those in which ‘something is happening’. These variables can be identified based on amplitude of oscillations.</li>
</ul>
<p>
</p><center>
<img src="figures/pdp_variables.png" width="60%">
</center>
<p></p>
</section>
<section id="ceteris-paribus---many-models" class="slide level2">
<h2>Ceteris Paribus - Many models</h2>
<ul>
<li>CP profile is a convenient tool for comparing models.</li>
<li>It can be particularly useful for comparing models from different families, e.g.&nbsp;tree vs.&nbsp;linear; flexible vs.&nbsp;rigid; regularised vs.&nbsp;interpolating edges (more on this later).</li>
</ul>
<p>
</p><center>
<img src="figures/pdp_models.png" width="70%">
</center>
<p></p>
</section>
<section id="ceteris-paribus---pros-and-cons" class="slide level2">
<h2>Ceteris Paribus - Pros and cons</h2>
<p><strong>Pros</strong></p>
<ul>
<li>Easy to communicate, and extendable approach to model exploration.</li>
<li>Graphical representation is easy to understand and explain.</li>
<li>CP profiles are easy to compare, as we can overlay profiles for two or more models to better understand differences between the models.</li>
</ul>
<p><strong>Cons</strong></p>
<ul>
<li>May lead to out-of-distribution problems if correlated explanatory variables are present. In this case application of the ceteris-paribus principle may lead to unrealistic settings and misleading results.</li>
<li>Think about prediction of an apartment’s price and correlated variables like no. rooms and surface area. You cannot change no. rooms freely keeping the surface constant.</li>
<li>Will not explain high-order interactions. Pairwise interactions require the use of two-dimensional CP and so on.</li>
<li>For models with hundreds or thousands of variables, the number of plots to inspect grow with number of variables.</li>
</ul>
</section></section>
<section>
<section id="part-6-variable-profile---model-level-analysis" class="title-slide slide level1 center">
<h1>Part 6: Variable profile - Model level analysis</h1>

</section>
<section class="slide level2">

<p>
</p><center>
<img src="figures/XAI_pdp.png" width="80%">
</center>
<p></p>
</section></section>
<section>
<section id="partial-dependence" class="title-slide slide level1 center">
<h1>Partial Dependence</h1>
<p><br><br><br></p>
</section>
<section id="partial-dependence---intutition" class="slide level2">
<h2>Partial Dependence - intutition</h2>
<ul>
<li>As with other explanations, we can aggregate local explanations to get a global view of how the model works.</li>
<li>Let’s average Ceteris Paribus profiles.</li>
</ul>
<p>
</p><center>
<img src="figures/pdp_avg.png" width="80%">
</center>
<p></p>
</section>
<section id="partial-dependence-in-action" class="slide level2">
<h2>Partial Dependence in action</h2>
<ul>
<li>Introduced in 2001 in the paper <em>Greedy Function Approximation: A Gradient Boosting Machine</em>. <a href="https://www.jstor.org/stable/2699986">Jerome Friedman. The Annals of Statistics 2001</a></li>
<li>Ceteris Paribus averaged profile following marginal distribution of variables <span class="math inline">\(X^{-j}\)</span>.</li>
</ul>
<p><span class="math display">\[
g^{PD}_{j}(z) = E_{X_{-j}}  f(X_{j|=z}) .
\]</span></p>
<ul>
<li>The estimation is based on the average of the CP profiles.</li>
<li>The computational complexity is <span class="math inline">\(N \times Z\)</span> model evaluations, where <span class="math inline">\(N\)</span> is the number of observations and <span class="math inline">\(Z\)</span> is the number of points at which the CP profile is calculated (<em>how to select these points?</em>).</li>
</ul>
<p><span class="math display">\[
\hat g^{PD}_{j}(z) =  \frac{1}{n} \sum_{i=1}^{n} f(x^i_{j|=z}).
\]</span></p>
</section>
<section id="partial-dependence-an-example" class="slide level2">
<h2>Partial Dependence, an example</h2>
<p>Let’s consider a simple linear regression model</p>
<p><span class="math display">\[
f(x) = \hat \mu + \hat \beta_1 x_1 + \hat \beta_2 x_2.
\]</span> Then we have</p>
<p><span class="math display">\[
g_{PD}^{1}(z) = E_{X_2} [\hat \mu + \hat \beta_1 z + \hat \beta_2 x_2] =
\]</span> <span class="math display">\[
\hat \mu + \hat \beta_1 z + \hat \beta_2 E_{X_2} [x_2] =
\]</span> <span class="math display">\[
\hat \beta_1 z + c
\]</span></p>
</section></section>
<section>
<section id="marginal-effects" class="title-slide slide level1 center">
<h1>Marginal Effects</h1>
<p><br><br><br></p>
</section>
<section id="marginal-effects---introduction" class="slide level2">
<h2>Marginal Effects - introduction</h2>
<ul>
<li>PD profiles are easy to explain, but unfortunately they inherit the disadvantages of CP profiles that average out.</li>
<li>One of these problems is that they are averaging over a marginal distribution, which may not be realistic.</li>
</ul>
<p><strong>What is the problem?</strong></p>
<ul>
<li>Consider two variables <span class="math inline">\(x_1\)</span> and <span class="math inline">\(x_2\)</span> which are highly correlated (see next slide).</li>
<li>If we calculate a profile for <span class="math inline">\(f\)</span> at <span class="math inline">\(x_1=0.4\)</span>, we average the model response over the marginal distribution of <span class="math inline">\(X_2\)</span>.</li>
<li>However, it might make more sense to average this model response after the conditional distribution <span class="math inline">\(X_2 | x_1=0.4\)</span>.</li>
</ul>
</section>
<section class="slide level2">

<p>Marginal distribution of <span class="math inline">\(X_2\)</span> on the left and conditional distribution of <span class="math inline">\(X_2|x_1=0.4\)</span> on the right.</p>
<p>
<img src="figures/pdp_mprofile.png" width="100%">
</p>
</section>
<section id="marginal-effects-in-action" class="slide level2">
<h2>Marginal Effects in action</h2>
<ul>
<li>Ceteris Paribus averaged over conditional distribution of variables <span class="math inline">\(X^{-j}|x^j=z\)</span>.</li>
</ul>
<p><span class="math display">\[
g^{MP}_{j}(z) = E_{X_{-j}|x_j=z}  f(x_{j|=z}) .
\]</span></p>
<ul>
<li>Note that, in general, the estimation of the conditional distribution <span class="math inline">\(X_{-j}|x^j=z\)</span> can be difficult.</li>
<li>One of the possible approaches: divide the variable <span class="math inline">\(x_j\)</span> into <span class="math inline">\(k\)</span> intervals. And then estimate <span class="math inline">\(X_{-j}|x_j=z\)</span> as the joint empirical distribution of observations <span class="math inline">\(i \in N(x_j)\)</span>, i.e.&nbsp;for which <span class="math inline">\(x^j\)</span> falls into the same interval.</li>
</ul>
<p><span class="math display">\[
\hat g^{MP}_{j}(z) = \frac{1}{|N(x_j)|} \sum_{i \in N(x_j)}   f(x^i_{j|=z}).
\]</span></p>
<p>
</p><center>
<img src="figures/pdp_mprofile2.png" width="80%">
</center>
<p></p>
</section>
<section id="marginal-effects-an-example" class="slide level2">
<h2>Marginal Effects, an example</h2>
<p>Let’s consider a simple linear regression model</p>
<p><span class="math display">\[
f(x) = \hat \mu + \hat \beta_1 x_1 + \hat \beta_2 x_2,
\]</span></p>
<p>with <span class="math inline">\(X_1 \sim \mathcal U[0,1]\)</span>, while <span class="math inline">\(x_2=x_1\)</span> (perfect correlation).</p>
<p>Then we have</p>
<p><span class="math display">\[
g^{MP}_{1}(z) = E_{X_2|x_1=z} [\hat \mu + \hat \beta_1 z + \hat \beta_2 x_2] =
\]</span> <span class="math display">\[
\hat \mu + \hat \beta_1 z + \hat \beta_2 E_{X_2|x_1=z} [x_2] =
\]</span> <span class="math display">\[
(\hat \beta_1 + \hat \beta_2) z + c
\]</span></p>
</section></section>
<section>
<section id="accumulated-local-effects" class="title-slide slide level1 center">
<h1>Accumulated Local Effects</h1>
<p><br><br><br></p>
</section>
<section id="accumulated-local-effects---introduction" class="slide level2">
<h2>Accumulated Local Effects - introduction</h2>
<ul>
<li><p>We have solved one problem, two new problems have emerged.</p></li>
<li><p>As we saw in the previous example, marginal effects carry the cummulative effect of all correlated variables. But is this what we wanted?</p></li>
<li><p>No.&nbsp;We want to take correlations into account, but distil the individual contribution of the variable <span class="math inline">\(x_j\)</span>. For this we will use <em>Accumulated Local Effects</em>.</p></li>
</ul>
</section>
<section id="accumulated-local-effects-in-action" class="slide level2">
<h2>Accumulated Local Effects in action</h2>
<ul>
<li>The key idea behind ALE profiles is to track the local curvature of the model, which can be captured by the model derivative.</li>
<li>These derivatives are shifted and averaged according to the conditional distribution <span class="math inline">\(X^{-j}|X^j=z\)</span>.</li>
<li>They are then accumulated so as to reproduce the effect of the variable <span class="math inline">\(x_j\)</span>.</li>
</ul>
<p><span class="math display">\[
g^{AL}_{j}(z) = \int_{z_0}^z \left[E_{X_{-j}|x_j=v}
\frac{\partial f(x)}{\partial x_j}  \right] dv .
\]</span> - As before, estimating the conditional distribution is difficult. We can deal with it by using a similar trick with <span class="math inline">\(k\)</span> segments of the variable <span class="math inline">\(x_j\)</span>. - Let <span class="math inline">\(k_j(x)\)</span> denote the interval in which the observation <span class="math inline">\(x\)</span> is located in respect to the variable <span class="math inline">\(j\)</span>. - We will accumulate local model changes on the interval<span class="math inline">\([z^{k-1}_j, z^k_j]\)</span>.</p>
<p><span class="math display">\[
\hat g^{AL}_{j}(z) = \sum_{k=1}^{k_j(x)} \frac{1}{|N_j(k)|}
\sum_{i:x_{i,j} \in N_j(k)} [f(x_{j|=z^k_j}) - f(x_{j|=z^{k-1}_j})] + c.
\]</span></p>
<p>
</p><center>
<img src="figures/pdp_mprofile3.png" width="80%">
</center>
<p></p>
</section>
<section id="accumulated-local-effects-an-example" class="slide level2">
<h2>Accumulated Local Effects, an example</h2>
<p>Let’s consider a simple linear regression model</p>
<p><span class="math display">\[
f(x) = \hat \mu + \hat \beta_1 x_1 + \hat \beta_2 x_2,
\]</span></p>
<p>with <span class="math inline">\(X_1 \sim \mathcal U[0,1]\)</span>, while <span class="math inline">\(x_2=x_1\)</span> (perfect correlation).</p>
<p>Then we have</p>
<p><span class="math display">\[
g^{AL}_{1}(z) = \int_0^z E_{X_2|x_1=v} \frac{\partial ( \hat \mu + \hat \beta_1 x_1 + \hat \beta_2 x_2)}{\partial x_1} dv + c=
\]</span> <span class="math display">\[
\int_0^z E_{X_2|x_1=v} \hat \beta_1 dv  +c =
\]</span> <span class="math display">\[
\int_0^z \hat \beta_1 dv +c =
\]</span> <span class="math display">\[
\hat \beta_1 z + c
\]</span></p>
</section>
<section id="how-they-are-different-12" class="slide level2">
<h2>How they are different? 1/2</h2>
<p>Let’s consider a following model</p>
<p><span class="math display">\[
f(x_1, x_2) = (x_1 +1)  x_2
\]</span></p>
<p>where <span class="math inline">\(X^1 \sim \mathcal U[-1,1]\)</span> and <span class="math inline">\(x_1=x_2\)</span>.</p>
<ul>
<li>Ceteris Paribus</li>
</ul>
<p><span class="math display">\[
h^1_{CP}(z) = (z+1)x_2
\]</span></p>
<ul>
<li>Partial Dependence</li>
</ul>
<p><span class="math display">\[
g^1_{PD}(z) = E_{X_2} (z+1)x_2 = 0
\]</span></p>
<ul>
<li>Marginal Effects</li>
</ul>
<p><span class="math display">\[
g_1^{MP}(z) = E_{X_2|x_1=z} (z+1)x_2 = z(z+1)
\]</span></p>
<ul>
<li>Accumulated Local Effects</li>
</ul>
<p><span class="math display">\[
g_1^{AL}(z) = \int_{-1}^z E_{X_2|x_1=v} \frac{\partial (x_1+1)x_2}{\partial x_1} dv = \int_{-1}^z E_{X_2|x_1=v} x_2 dv =
\]</span> <span class="math display">\[
\int_{-1}^z v dv =  (z^2  - 1)/2
\]</span></p>
</section>
<section id="how-they-are-different-22" class="slide level2">
<h2>How they are different? 2/2</h2>
<p>Let’s explain the model with a following sample</p>
<table>
<colgroup>
<col style="width: 12%">
<col style="width: 6%">
<col style="width: 12%">
<col style="width: 12%">
<col style="width: 12%">
<col style="width: 12%">
<col style="width: 12%">
<col style="width: 12%">
<col style="width: 8%">
</colgroup>
<thead>
<tr class="header">
<th>i</th>
<th>1</th>
<th>2</th>
<th>3</th>
<th>4</th>
<th>5</th>
<th>6</th>
<th>7</th>
<th>8</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><span class="math inline">\(X^1\)</span></td>
<td>-1</td>
<td>-0.71</td>
<td>-0.43</td>
<td>-0.14</td>
<td>0.14</td>
<td>0.43</td>
<td>0.71</td>
<td>1</td>
</tr>
<tr class="even">
<td><span class="math inline">\(X^2\)</span></td>
<td>-1</td>
<td>-0.71</td>
<td>-0.43</td>
<td>-0.14</td>
<td>0.14</td>
<td>0.43</td>
<td>0.71</td>
<td>1</td>
</tr>
<tr class="odd">
<td><span class="math inline">\(y\)</span></td>
<td>0</td>
<td>-0.2059</td>
<td>-0.2451</td>
<td>-0.1204</td>
<td>0.1596</td>
<td>0.6149</td>
<td>1.2141</td>
<td>2</td>
</tr>
</tbody>
</table>
<p>The figure below summaries differences between PD, ME and ALE.</p>
<p>
</p><center>
<img src="figures/CP_ALL.png" width="80%">
</center>
<p></p>
</section></section>
<section>
<section id="local-effects---examples" class="title-slide slide level1 center">
<h1>Local Effects - Examples</h1>
<p><br><br><br></p>
</section>
<section id="groups-of-local-effects" class="slide level2">
<h2>Groups of Local Effects</h2>
<ul>
<li>The global explanation is an aggregation of local CP profiles.</li>
<li>But we don’t need to average by all observations, we can average by groups.</li>
<li>How do we define these groups? E.g. based on the value of another variable.</li>
<li>Profiles constructed in this way help to identify interactions between variables.</li>
</ul>
<p>
</p><center>
<img src="figures/pdp_cluster2.png" width="60%">
</center>
<p></p>
</section>
<section id="clustering-of-local-effects" class="slide level2">
<h2>Clustering of Local Effects</h2>
<ul>
<li>Or one can cluster CP profiles and calculate average over clusters.</li>
</ul>
<p>
</p><center>
<img src="figures/pdp_cluster1.png" width="60%">
</center>
<p></p>
</section>
<section id="covid-example" class="slide level2">
<h2>Covid example</h2>
<ul>
<li>The figure below shows PD profiles calculated on real Covid-19 mortality data from year 2020 in Poland.</li>
<li>Presented are the results of two models, logistic regression with splines (GLM) and the XGBoost tree model.</li>
<li>PDP profiles are calculated separately according to whether the patient had comorbidities or not. Differences in mortality can be read from the plot.</li>
<li>What makes it possible to compare the models?</li>
</ul>
<p>
</p><center>
<img src="figures/pdp_covid.png" width="60%">
</center>
<p></p>
<p><a href="https://betaandbit.github.io/RML/">Data and models</a></p>
</section>
<section id="profile-for-a-single-prediction" class="slide level2">
<h2>Profile for a single prediction</h2>
<ul>
<li><p><em>Ceteris paribus</em> is a Latin phrase, meaning ,,all other things being equal’’ or ,,all else unchanged’’, <a href="https://en.wikipedia.org/wiki/Ceteris_paribus">see Wikipedia</a>.</p></li>
<li><p>It is a function defined for model <span class="math inline">\(f\)</span>, observation <span class="math inline">\(x\)</span>, and variable <span class="math inline">\(j\)</span> as:</p></li>
</ul>
<p><span class="math display">\[
h^{f}_{x,j}(z) = f\left(x_{j|=z}\right),
\]</span></p>
<p>where <span class="math inline">\(x_{j|=z}\)</span> stands for observation <span class="math inline">\(x\)</span> with <span class="math inline">\(j\)</span>-th coordinate replaced by value <span class="math inline">\(z\)</span>.</p>
<ul>
<li><p>The Ceteris Paribus profile is a function that describes how the model response would change if <span class="math inline">\(j\)</span>-th variable will be changed to <span class="math inline">\(z\)</span> while values of all other variables are kept fixed at the values specified by <span class="math inline">\(x\)</span>.</p></li>
<li><p>In the implementation we cannot check all possible z’s, we have to meaningfully select a subset of them, we will come back to this later.</p></li>
<li><p>Note that CP profiles are also commonly referred as <em>Individual Conditional Expectation (ICE) profiles</em>. This is a common name but might be misleading if the model does not predict the expected value.</p></li>
</ul>
</section>
<section id="profile-for-a-single-prediction-1" class="slide level2">
<h2>Profile for a single prediction</h2>
<p>While local variable attribution is a convenient technique for answering the question of <strong>which</strong> variables affect the prediction, the local profile analysis is a good technique for answering the question of <strong>how</strong> the model response depends on a particular variable. Or answering the question of <strong>what if</strong>…</p>
<p>The <code>predict_profiles()</code> function calculated CP profiles for a selected observation, model and vector of variables (all continuous variables by default).</p>
<p><a href="http://ema.drwhy.ai/ceterisParibus.html">More info</a></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb89"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb89-1"><a href="#cb89-1"></a>mprof_forest <span class="ot">&lt;-</span> <span class="fu">predict_profile</span>(model_forest, Steve, <span class="st">"Age"</span>)</span>
<span id="cb89-2"><a href="#cb89-2"></a><span class="fu">plot</span>(mprof_forest)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>

</div>
<img data-src="SPE2025_files/figure-revealjs/unnamed-chunk-34-1.png" style="width:70.0%" class="r-stretch"><p>CP profiles can be visualized with the generic <code>plot()</code> function.</p>
</section>
<section id="profile-for-many-models" class="slide level2">
<h2>Profile for many models</h2>
<p>For technical reasons, quantitative and qualitative variables cannot be shown in a single chart. So if you want to show the importance of quality variables you need to plot them separately.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb90"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb90-1"><a href="#cb90-1"></a>mprof_forest <span class="ot">&lt;-</span> <span class="fu">predict_profile</span>(model_forest, <span class="at">variable_splits =</span> <span class="fu">list</span>(<span class="at">Age=</span><span class="dv">0</span><span class="sc">:</span><span class="dv">100</span>), Steve)</span>
<span id="cb90-2"><a href="#cb90-2"></a>mprof_tree <span class="ot">&lt;-</span> <span class="fu">predict_profile</span>(model_tree, <span class="at">variable_splits =</span> <span class="fu">list</span>(<span class="at">Age=</span><span class="dv">0</span><span class="sc">:</span><span class="dv">100</span>), Steve)</span>
<span id="cb90-3"><a href="#cb90-3"></a>mprof_lmr_rcs <span class="ot">&lt;-</span> <span class="fu">predict_profile</span>(model_lmr_rcs, <span class="at">variable_splits =</span> <span class="fu">list</span>(<span class="at">Age=</span><span class="dv">0</span><span class="sc">:</span><span class="dv">100</span>), Steve)</span>
<span id="cb90-4"><a href="#cb90-4"></a></span>
<span id="cb90-5"><a href="#cb90-5"></a><span class="fu">plot</span>(mprof_forest, mprof_lmr_rcs, mprof_tree)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>

</div>
<img data-src="SPE2025_files/figure-revealjs/unnamed-chunk-35-1.png" style="width:70.0%" class="r-stretch"></section>
<section id="profile-for-many-variables" class="slide level2">
<h2>Profile for many variables</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb91"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb91-1"><a href="#cb91-1"></a>mprof_forest <span class="ot">&lt;-</span> <span class="fu">predict_profile</span>(model_forest, <span class="at">variables =</span> <span class="st">"Age"</span>, Steve)</span>
<span id="cb91-2"><a href="#cb91-2"></a>pl1 <span class="ot">&lt;-</span> <span class="fu">plot</span>(mprof_forest) <span class="sc">+</span> <span class="fu">ggtitle</span>(<span class="st">"Ceteris paribus for Ranger"</span>)<span class="sc">+</span></span>
<span id="cb91-3"><a href="#cb91-3"></a><span class="fu">scale_y_continuous</span>(<span class="st">"prediction"</span>, <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="fl">0.55</span>)) </span>
<span id="cb91-4"><a href="#cb91-4"></a></span>
<span id="cb91-5"><a href="#cb91-5"></a>mprof_forest2 <span class="ot">&lt;-</span> <span class="fu">predict_profile</span>(model_forest, <span class="at">variables =</span> <span class="st">"Cardiovascular.Diseases"</span>, Steve)</span>
<span id="cb91-6"><a href="#cb91-6"></a>pl2 <span class="ot">&lt;-</span> <span class="fu">plot</span>(mprof_forest2, <span class="at">variable_type =</span> <span class="st">"categorical"</span>, <span class="at">variables =</span> <span class="st">"Cardiovascular.Diseases"</span>, <span class="at">categorical_type =</span> <span class="st">"lines"</span>)  <span class="sc">+</span> <span class="fu">ggtitle</span>(<span class="st">"Ceteris paribus for Ranger"</span>)<span class="sc">+</span></span>
<span id="cb91-7"><a href="#cb91-7"></a><span class="fu">scale_y_continuous</span>(<span class="st">"prediction"</span>, <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="fl">0.55</span>)) </span>
<span id="cb91-8"><a href="#cb91-8"></a></span>
<span id="cb91-9"><a href="#cb91-9"></a><span class="fu">library</span>(<span class="st">"patchwork"</span>)</span>
<span id="cb91-10"><a href="#cb91-10"></a>pl1 <span class="sc">+</span> pl2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>

</div>
<img data-src="SPE2025_files/figure-revealjs/unnamed-chunk-36-1.png" style="width:70.0%" class="r-stretch"></section>
<section id="ceteris-paribus---pros-and-cons-1" class="slide level2">
<h2>Ceteris Paribus - Pros and cons</h2>
<p><strong>Pros</strong></p>
<ul>
<li>Easy to communicate, and extendable approach to model exploration.</li>
<li>Graphical representation is easy to understand and explain.</li>
<li>CP profiles are easy to compare, as we can overlay profiles for two or more models to better understand differences between the models.</li>
</ul>
<p><strong>Cons</strong></p>
<ul>
<li>May lead to out-of-distribution problems if correlated explanatory variables are present. In this case application of the ceteris-paribus principle may lead to unrealistic settings and misleading results.</li>
<li>Think about prediction of an apartment’s price and correlated variables like no. rooms and surface area. You cannot change no. rooms freely keeping the surface constant.</li>
<li>Will not explain high-order interactions. Pairwise interactions require the use of two-dimensional CP and so on.</li>
<li>For models with hundreds or thousands of variables, the number of plots to inspect grow with number of variables.</li>
</ul>
</section>
<section id="python-snippets---ceteris-paribus" class="slide level2">
<h2>Python snippets - Ceteris Paribus</h2>
<h3 id="ceteris-paribus-profile-for-a-single-model">Ceteris Paribus profile for a single model</h3>
<pre><code>cp_steve = explainer_rfc_tuned.predict_profile(Steve)

cp_steve.plot(variables="Age", show=False)</code></pre>
<h3 id="ceteris-paribus-profile-for-few-models">Ceteris Paribus profile for few models</h3>
<pre><code>cp_cdc = explainer_cdc.predict_profile(Steve)
cp_dtc = explainer_dtc.predict_profile(Steve)
cp_rfc = explainer_rfc.predict_profile(Steve)

cp_cdc.plot([cp_rfc, cp_dtc, cp_steve], variables="Age", show=False)</code></pre>
</section>
<section id="partial-dependence---intutition-1" class="slide level2">
<h2>Partial Dependence - intutition</h2>
<ul>
<li>As with other explanations, we can aggregate local explanations to get a global view of how the model works.</li>
<li>Let’s average Ceteris Paribus profiles.</li>
</ul>
<p>
</p><center>
<img src="figures/pdp_avg.png" width="80%">
</center>
<p></p>
</section>
<section id="partial-dependence-in-action-1" class="slide level2">
<h2>Partial Dependence in action</h2>
<p>Once we know which variables are important, it is usually interesting to determine the relationship between a particular variable and the model prediction. Popular techniques for this type of Explanatory Model Analysis are Partial Dependence (PD) and Accumulated Local Effects (ALE).</p>
<p>Introduced in 2001 in the paper <em>Greedy Function Approximation: A Gradient Boosting Machine</em>. <a href="https://www.jstor.org/stable/2699986">Jerome Friedman. The Annals of Statistics 2001</a></p>
<p>Ceteris Paribus averaged profile following marginal distribution of variables <span class="math inline">\(X^{-j}\)</span>.</p>
<p><span class="math display">\[
PD(i, t) = E\left[ f(x_1, ..., x_{i-1}, t, x_{i+1}, ..., x_p) \right],
\]</span></p>
<p>The estimation is based on the average of the CP profiles.</p>
<p>The computational complexity is <span class="math inline">\(N \times Z\)</span> model evaluations, where <span class="math inline">\(N\)</span> is the number of observations and <span class="math inline">\(Z\)</span> is the number of points at which the CP profile is calculated (<em>how to select these points?</em>).</p>
<p><span class="math display">\[
\widehat{PD}(i, t) = \frac 1n \sum_{j=1}^n f(x^j_1, ..., x^j_{i-1}, t, x^j_{i+1}, ..., x^j_p).
\]</span></p>
<p>Replacing <span class="math inline">\(i\)</span>-th variable by value <span class="math inline">\(t\)</span> can lead to very strange observations, especially when <span class="math inline">\(i\)</span>-th variable is correlated with other variables and we ignore the correlation structure. One solution to this are Accumulated Local Effects profiles, which average over the conditional distribution.</p>
<p>ALE method was introduced in <a href="https://rss.onlinelibrary.wiley.com/doi/abs/10.1111/rssb.12377">Visualizing the effects of predictor variables in black box supervised learning models</a> by Daniel Apley and Jingyu Zhu</p>
</section>
<section id="model-level-analysis" class="slide level2">
<h2>Model level analysis</h2>
<p>The <code>model_profiles()</code> function calculates PD profiles for a specified model and variables (all by default).</p>
<p><a href="http://ema.drwhy.ai/partialDependenceProfiles.html">More info</a></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb94"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb94-1"><a href="#cb94-1"></a>mprof_forest <span class="ot">&lt;-</span> <span class="fu">model_profile</span>(model_forest, <span class="st">"Age"</span>)</span>
<span id="cb94-2"><a href="#cb94-2"></a><span class="fu">plot</span>(mprof_forest) <span class="sc">+</span></span>
<span id="cb94-3"><a href="#cb94-3"></a>  <span class="fu">ggtitle</span>(<span class="st">"PD profile"</span>,<span class="st">""</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>

</div>
<img data-src="SPE2025_files/figure-revealjs/unnamed-chunk-37-1.png" style="width:70.0%" class="r-stretch"></section>
<section id="grouped-partial-dependence-profiles" class="slide level2">
<h2>Grouped partial dependence profiles</h2>
<p>By default, the average is calculated for all observations. But with the argument <code>groups=</code> one can specify a factor variable in which CP profiles will be averaged.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb95"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb95-1"><a href="#cb95-1"></a>mgroup_forest <span class="ot">&lt;-</span> <span class="fu">model_profile</span>(model_forest, <span class="at">variable_splits =</span> <span class="fu">list</span>(<span class="at">Age =</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">100</span>), </span>
<span id="cb95-2"><a href="#cb95-2"></a>                    <span class="at">groups =</span> <span class="st">"Diabetes"</span>)</span>
<span id="cb95-3"><a href="#cb95-3"></a><span class="fu">plot</span>(mgroup_forest)<span class="sc">+</span></span>
<span id="cb95-4"><a href="#cb95-4"></a>  <span class="fu">ggtitle</span>(<span class="st">"PD profiles for groups"</span>,<span class="st">""</span>) <span class="sc">+</span> <span class="fu">ylab</span>(<span class="st">""</span>) <span class="sc">+</span> <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"top"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>

</div>
<img data-src="SPE2025_files/figure-revealjs/unnamed-chunk-38-1.png" style="width:70.0%" class="r-stretch"></section>
<section id="many-models" class="slide level2">
<h2>Many models</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb96"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb96-1"><a href="#cb96-1"></a>mprof_forest <span class="ot">&lt;-</span> <span class="fu">model_profile</span>(model_forest, <span class="at">variable_splits =</span> <span class="fu">list</span>(<span class="at">Age=</span><span class="dv">0</span><span class="sc">:</span><span class="dv">100</span>))</span>
<span id="cb96-2"><a href="#cb96-2"></a>mprof_tree <span class="ot">&lt;-</span> <span class="fu">model_profile</span>(model_tree, <span class="at">variable_splits =</span> <span class="fu">list</span>(<span class="at">Age=</span><span class="dv">0</span><span class="sc">:</span><span class="dv">100</span>))</span>
<span id="cb96-3"><a href="#cb96-3"></a>mprof_lmr_rcs <span class="ot">&lt;-</span> <span class="fu">model_profile</span>(model_lmr_rcs, <span class="at">variable_splits =</span> <span class="fu">list</span>(<span class="at">Age=</span><span class="dv">0</span><span class="sc">:</span><span class="dv">100</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Profiles can be then drawn with the <code>plot()</code> function.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb97"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb97-1"><a href="#cb97-1"></a><span class="fu">plot</span>(mprof_forest, mprof_lmr_rcs, mprof_tree) <span class="sc">+</span>  <span class="fu">ggtitle</span>(<span class="st">""</span>,<span class="st">""</span>) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>

</div>
<img data-src="SPE2025_files/figure-revealjs/unnamed-chunk-40-1.png" style="width:70.0%" class="r-stretch"><p>If the model is additive, all CP profiles are parallel. But if the model has interactions, CP profiles may have different shapes for different observations. Defining the k argument allows to find and calculate the average in k segments of CP profiles.</p>
</section>
<section id="python-snippets---partial-dependence" class="slide level2">
<h2>Python snippets - partial dependence</h2>
<h3 id="calculate-partial-dependence-profiles-for-a-single-model">Calculate Partial Dependence profiles for a single model</h3>
<p>for variable <code>Age</code> and plot it</p>
<pre><code>profile_rfc = explainer_rfc.model_profile(variables="Age")
profile_rfc.plot(show=False)</code></pre>
<h3 id="calculate-partial-dependence-profiles-for-few-models">Calculate Partial Dependence profiles for few models</h3>
<p>for variable <code>Age</code> and plot it</p>
<pre><code>profile_cdc = explainer_cdc.model_profile(variables="Age")
profile_dtc = explainer_dtc.model_profile(variables="Age")
profile_rfc_tuned = explainer_rfc_tuned.model_profile(
        variables="Age")

profile_cdc.plot([profile_rfc, profile_dtc, 
        profile_rfc_tuned], show=False)</code></pre>
<h3 id="calculate-partial-dependence-profiles">Calculate Partial Dependence profiles</h3>
<p>for variable <code>Age</code> in groups defined by variable <code>Diabetes</code> and plot it</p>
<pre><code>grouped_profile_rfc_tuned = explainer_rfc_tuned.model_profile(variables="Age", groups="Diabetes")

grouped_profile_rfc_tuned.plot(show=False)</code></pre>
</section>
<section id="your-turn-3" class="slide level2">
<h2>Your turn</h2>
<ul>
<li>Train random forest model, tree based model and regression based models for selected data (<code>covid_summer</code>, <code>heart</code>, <code>lung</code>)</li>
<li>Choose (or create) a single observation</li>
<li>Calculate and plot Ceteris-paribus profiles for one model.</li>
<li>Compare results for different models.</li>
</ul>
</section></section>
<section>
<section id="extras" class="title-slide slide level1 center">
<h1>Extras</h1>

</section>
<section id="model-deployment" class="slide level2">
<h2>Model deployment</h2>
<p>We have made the model built for Covid data, along with the explanations described in this book, available at webpage. After two months, tens of thousands of people used it. With proper tools the deployment of such a model is not difficult.</p>
<p>To obtain a safe and effective model, it is necessary to perform a detailed Explanatory Model Analysis. However, we often don’t have much time for it. That is why tools that facilitate fast and automated model exploration are so useful.</p>
<p>One of such tools is <code>modelStudio</code>. It is a package that transforms an explainer into an HTML page with javascript based interaction. Such an HTML page is easy to save on a disk or share by email. The webpage has various explanations pre-calculated, so its generation may be time-consuming, but the model exploration is very fast, and the feedback loop is tight.</p>
<p>Generating a <code>modelStudio</code> for an explainer is trivially easy.</p>
<p><a href="https://github.com/ModelOriented/modelStudio/blob/master/README.md">More info</a></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb101"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb101-1"><a href="#cb101-1"></a><span class="fu">library</span>(<span class="st">"modelStudio"</span>)</span>
<span id="cb101-2"><a href="#cb101-2"></a></span>
<span id="cb101-3"><a href="#cb101-3"></a>ms <span class="ot">&lt;-</span> <span class="fu">modelStudio</span>(model_forest, <span class="at">new_observation =</span> Steve)</span>
<span id="cb101-4"><a href="#cb101-4"></a>ms</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="shift-in-our-focus-statistics" class="slide level2">
<h2>Shift in our focus: Statistics</h2>
<ul>
<li>Statistical analysis of data most often assumes a great deal of knowledge about the phenomenon. Understanding the data allows to choose appropriate transformations, representations. Verification is oriented toward hypothesis testing, such as by p-values</li>
</ul>
<p>
</p><center>
<img src="figures/shift1.png" width="100%">
</center>
<p></p>
</section>
<section id="shift-in-our-focus-machine-learning" class="slide level2">
<h2>Shift in our focus: Machine Learning</h2>
<ul>
<li>Machine learning puts a priority on optimizing the model, especially for performance. There is a lot of searching through the space of possible solutions here to find the best one</li>
<li>Knowledge of the phenomenon is no longer so important</li>
</ul>
<p>
</p><center>
<img src="figures/shift2.png" width="100%">
</center>
<p></p>
</section>
<section id="shift-in-our-focus-human-oriented-ml" class="slide level2">
<h2>Shift in our focus: Human Oriented ML?</h2>
<ul>
<li>What’s next. If model building can be easily and quickly automated, in-depth model verification will become more important</li>
<li>This is where models are created seamlessly according to the needs of the user, and the user can focus on decisions supported by the models</li>
</ul>
<p>
</p><center>
<img src="figures/shift3.png" width="100%">
</center>
<p></p>
</section>
<section id="take-home-message" class="slide level2">
<h2>Take-home message</h2>
<p><strong>Why interpretability is important?</strong></p>
<ul>
<li>Higher trust -&gt; <strong>higher adoption of ML solutions</strong> that will support decision making process</li>
<li>May be <strong>required by auditors, regulators</strong>, law</li>
<li>New tool for model exploration -&gt; to <strong>gain new insights</strong> about the data/nature of some phenomenon</li>
<li>Gate keeping role, human can <strong>control and/or block wrong decisions</strong> when knowing key reasons behind these decisions</li>
<li><strong>Debugg/improve data or models</strong>, identify wrong behavior and help to plan actions to fix it</li>
<li><strong>Deeper diagnostic of models</strong>, validation against some domain knowledge, expectations or other values (like human rights -&gt; fairness)</li>
</ul>
</section>
<section class="slide level2">


<img data-src="figures/rml_comic_12.png" class="r-stretch"></section></section>
<section id="session-info" class="title-slide slide level1 center">
<h1>Session info</h1>
<div class="cell">
<div class="sourceCode cell-code" id="cb102"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb102-1"><a href="#cb102-1"></a>devtools<span class="sc">::</span><span class="fu">session_info</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>─ Session info ───────────────────────────────────────────────────────────────
 setting  value
 version  R version 4.5.1 (2025-06-13)
 os       macOS Sequoia 15.6.1
 system   x86_64, darwin20
 ui       X11
 language (EN)
 collate  en_US.UTF-8
 ctype    en_US.UTF-8
 tz       Europe/Warsaw
 date     2025-10-20
 pandoc   3.6.3 @ /Applications/RStudio.app/Contents/Resources/app/quarto/bin/tools/x86_64/ (via rmarkdown)
 quarto   1.3.450 @ /usr/local/bin/quarto

─ Packages ───────────────────────────────────────────────────────────────────
 package        * version date (UTC) lib source
 backports        1.5.0   2024-05-23 [1] CRAN (R 4.5.0)
 base64enc        0.1-3   2015-07-28 [1] CRAN (R 4.5.0)
 bbotk            1.7.0   2025-10-10 [1] CRAN (R 4.5.1)
 cachem           1.1.0   2024-05-16 [1] CRAN (R 4.5.0)
 checkmate        2.3.3   2025-08-18 [1] CRAN (R 4.5.1)
 class            7.3-23  2025-01-01 [1] CRAN (R 4.5.1)
 cli              3.6.5   2025-04-23 [1] CRAN (R 4.5.0)
 cluster          2.1.8.1 2025-03-12 [1] CRAN (R 4.5.1)
 codetools        0.2-20  2024-03-31 [1] CRAN (R 4.5.1)
 colorspace       2.1-2   2025-09-22 [1] CRAN (R 4.5.1)
 crayon           1.5.3   2024-06-20 [1] CRAN (R 4.5.0)
 DALEX          * 2.5.3   2025-10-19 [1] local
 data.table       1.17.8  2025-07-10 [1] CRAN (R 4.5.1)
 DBI              1.2.3   2024-06-02 [1] CRAN (R 4.5.0)
 devtools         2.4.5   2022-10-11 [1] CRAN (R 4.5.0)
 digest           0.6.37  2024-08-19 [1] CRAN (R 4.5.0)
 dplyr            1.1.4   2023-11-17 [1] CRAN (R 4.5.0)
 e1071            1.7-16  2024-09-16 [1] CRAN (R 4.5.0)
 ellipsis         0.3.2   2021-04-29 [1] CRAN (R 4.5.0)
 evaluate         1.0.4   2025-06-18 [1] CRAN (R 4.5.0)
 farver           2.1.2   2024-05-13 [1] CRAN (R 4.5.0)
 fastmap          1.2.0   2024-05-15 [1] CRAN (R 4.5.0)
 forcats          1.0.0   2023-01-29 [1] CRAN (R 4.5.0)
 foreign          0.8-90  2025-03-31 [1] CRAN (R 4.5.1)
 Formula          1.2-5   2023-02-24 [1] CRAN (R 4.5.0)
 fs               1.6.6   2025-04-12 [1] CRAN (R 4.5.0)
 future         * 1.58.0  2025-06-05 [1] CRAN (R 4.5.0)
 future.apply     1.20.0  2025-06-06 [1] CRAN (R 4.5.0)
 generics         0.1.4   2025-05-09 [1] CRAN (R 4.5.0)
 ggplot2        * 4.0.0   2025-09-11 [1] CRAN (R 4.5.1)
 globals          0.18.0  2025-05-08 [1] CRAN (R 4.5.0)
 glue             1.8.0   2024-09-30 [1] CRAN (R 4.5.0)
 gridExtra        2.3     2017-09-09 [1] CRAN (R 4.5.0)
 gtable           0.3.6   2024-10-25 [1] CRAN (R 4.5.0)
 haven            2.5.5   2025-05-30 [1] CRAN (R 4.5.0)
 Hmisc          * 5.2-4   2025-10-05 [1] CRAN (R 4.5.1)
 hms              1.1.3   2023-03-21 [1] CRAN (R 4.5.0)
 htmlTable        2.4.3   2024-07-21 [1] CRAN (R 4.5.0)
 htmltools        0.5.8.1 2024-04-04 [1] CRAN (R 4.5.0)
 htmlwidgets      1.6.4   2023-12-06 [1] CRAN (R 4.5.0)
 httpuv           1.6.16  2025-04-16 [1] CRAN (R 4.5.0)
 iBreakDown       2.1.2   2023-12-01 [1] CRAN (R 4.5.0)
 ingredients      2.3.0   2023-01-15 [1] CRAN (R 4.5.0)
 inum             1.0-5   2023-03-09 [1] CRAN (R 4.5.0)
 jsonlite         2.0.0   2025-03-27 [1] CRAN (R 4.5.0)
 knitr            1.50    2025-03-16 [1] CRAN (R 4.5.0)
 labeling         0.4.3   2023-08-29 [1] CRAN (R 4.5.0)
 labelled         2.15.0  2025-09-16 [1] CRAN (R 4.5.1)
 later            1.4.2   2025-04-08 [1] CRAN (R 4.5.0)
 lattice          0.22-7  2025-04-02 [1] CRAN (R 4.5.1)
 lgr              0.5.0   2025-07-23 [1] CRAN (R 4.5.1)
 libcoin        * 1.0-10  2023-09-27 [1] CRAN (R 4.5.0)
 lifecycle        1.0.4   2023-11-07 [1] CRAN (R 4.5.0)
 listenv          0.9.1   2024-01-29 [1] CRAN (R 4.5.0)
 magrittr         2.0.3   2022-03-30 [1] CRAN (R 4.5.0)
 MASS             7.3-65  2025-02-28 [1] CRAN (R 4.5.1)
 Matrix           1.7-3   2025-03-11 [1] CRAN (R 4.5.1)
 MatrixModels     0.5-4   2025-03-26 [1] CRAN (R 4.5.0)
 memoise          2.0.1   2021-11-26 [1] CRAN (R 4.5.0)
 mime             0.13    2025-03-17 [1] CRAN (R 4.5.0)
 miniUI           0.1.2   2025-04-17 [1] CRAN (R 4.5.0)
 mitools          2.4     2019-04-26 [1] CRAN (R 4.5.0)
 mlr3           * 1.2.0   2025-09-13 [1] CRAN (R 4.5.1)
 mlr3learners   * 0.13.0  2025-10-02 [1] CRAN (R 4.5.1)
 mlr3measures     1.1.0   2025-09-04 [1] CRAN (R 4.5.1)
 mlr3misc         0.19.0  2025-09-12 [1] CRAN (R 4.5.1)
 mlr3tuning     * 1.4.0   2025-06-04 [1] CRAN (R 4.5.0)
 multcomp         1.4-28  2025-01-29 [1] CRAN (R 4.5.0)
 mvtnorm        * 1.3-3   2025-01-10 [1] CRAN (R 4.5.0)
 nlme             3.1-168 2025-03-31 [1] CRAN (R 4.5.1)
 nnet             7.3-20  2025-01-01 [1] CRAN (R 4.5.1)
 palmerpenguins   0.1.1   2022-08-15 [1] CRAN (R 4.5.0)
 paradox        * 1.0.1   2024-07-09 [1] CRAN (R 4.5.0)
 parallelly       1.45.1  2025-07-24 [1] CRAN (R 4.5.1)
 partykit       * 1.2-24  2025-05-02 [1] CRAN (R 4.5.0)
 patchwork      * 1.3.1   2025-06-21 [1] CRAN (R 4.5.0)
 pillar           1.11.0  2025-07-04 [1] CRAN (R 4.5.1)
 pkgbuild         1.4.8   2025-05-26 [1] CRAN (R 4.5.0)
 pkgconfig        2.0.3   2019-09-22 [1] CRAN (R 4.5.0)
 pkgload          1.4.0   2024-06-28 [1] CRAN (R 4.5.0)
 polspline        1.1.25  2024-05-10 [1] CRAN (R 4.5.0)
 profvis          0.4.0   2024-09-20 [1] CRAN (R 4.5.0)
 promises         1.3.3   2025-05-29 [1] CRAN (R 4.5.0)
 proxy            0.4-27  2022-06-09 [1] CRAN (R 4.5.0)
 purrr            1.1.0   2025-07-10 [1] CRAN (R 4.5.1)
 quantreg         6.1     2025-03-10 [1] CRAN (R 4.5.0)
 R6               2.6.1   2025-02-15 [1] CRAN (R 4.5.0)
 ranger         * 0.17.0  2024-11-08 [1] CRAN (R 4.5.0)
 RColorBrewer     1.1-3   2022-04-03 [1] CRAN (R 4.5.0)
 Rcpp             1.1.0   2025-07-02 [1] CRAN (R 4.5.1)
 remotes          2.5.0   2024-03-17 [1] CRAN (R 4.5.0)
 rlang            1.1.6   2025-04-11 [1] CRAN (R 4.5.0)
 rmarkdown        2.29    2024-11-04 [1] CRAN (R 4.5.0)
 rms            * 8.1-0   2025-10-14 [1] CRAN (R 4.5.1)
 rpart            4.1.24  2025-01-07 [1] CRAN (R 4.5.1)
 rstudioapi       0.17.1  2024-10-22 [1] CRAN (R 4.5.0)
 S7               0.2.0   2024-11-07 [1] CRAN (R 4.5.0)
 sandwich         3.1-1   2024-09-15 [1] CRAN (R 4.5.0)
 scales           1.4.0   2025-04-24 [1] CRAN (R 4.5.0)
 sessioninfo      1.2.3   2025-02-05 [1] CRAN (R 4.5.0)
 shiny            1.11.1  2025-07-03 [1] CRAN (R 4.5.1)
 SparseM          1.84-2  2024-07-17 [1] CRAN (R 4.5.0)
 stringi          1.8.7   2025-03-27 [1] CRAN (R 4.5.0)
 stringr          1.5.1   2023-11-14 [1] CRAN (R 4.5.0)
 survey           4.4-8   2025-08-28 [1] CRAN (R 4.5.1)
 survival         3.8-3   2024-12-17 [1] CRAN (R 4.5.1)
 tableone       * 0.13.2  2022-04-15 [1] CRAN (R 4.5.0)
 TH.data          1.1-4   2025-09-02 [1] CRAN (R 4.5.1)
 tibble           3.3.0   2025-06-08 [1] CRAN (R 4.5.0)
 tidyselect       1.2.1   2024-03-11 [1] CRAN (R 4.5.0)
 urlchecker       1.0.1   2021-11-30 [1] CRAN (R 4.5.0)
 usethis          3.1.0   2024-11-26 [1] CRAN (R 4.5.0)
 uuid             1.2-1   2024-07-29 [1] CRAN (R 4.5.0)
 vctrs            0.6.5   2023-12-01 [1] CRAN (R 4.5.0)
 withr            3.0.2   2024-10-28 [1] CRAN (R 4.5.0)
 xfun             0.52    2025-04-02 [1] CRAN (R 4.5.0)
 xtable           1.8-4   2019-04-21 [1] CRAN (R 4.5.0)
 yaml             2.3.10  2024-07-26 [1] CRAN (R 4.5.0)
 zoo              1.8-14  2025-04-10 [1] CRAN (R 4.5.0)

 [1] /Library/Frameworks/R.framework/Versions/4.5-x86_64/Resources/library
 * ── Packages attached to the search path.

──────────────────────────────────────────────────────────────────────────────</code></pre>
</div>
</div>

<img src="figures/XAI.png" class="slide-logo r-stretch"><div class="footer footer-default">
<p>Responsible Machine Learning – SPE 2025 – 2025/10/22</p>
</div>
</section>
    </div>
  </div>

  <script>window.backupDefine = window.define; window.define = undefined;</script>
  <script src="SPE2025_files/libs/revealjs/dist/reveal.js"></script>
  <!-- reveal.js plugins -->
  <script src="SPE2025_files/libs/revealjs/plugin/quarto-line-highlight/line-highlight.js"></script>
  <script src="SPE2025_files/libs/revealjs/plugin/pdf-export/pdfexport.js"></script>
  <script src="SPE2025_files/libs/revealjs/plugin/reveal-menu/menu.js"></script>
  <script src="SPE2025_files/libs/revealjs/plugin/reveal-menu/quarto-menu.js"></script>
  <script src="SPE2025_files/libs/revealjs/plugin/reveal-chalkboard/plugin.js"></script>
  <script src="SPE2025_files/libs/revealjs/plugin/quarto-support/support.js"></script>
  

  <script src="SPE2025_files/libs/revealjs/plugin/notes/notes.js"></script>
  <script src="SPE2025_files/libs/revealjs/plugin/search/search.js"></script>
  <script src="SPE2025_files/libs/revealjs/plugin/zoom/zoom.js"></script>
  <script src="SPE2025_files/libs/revealjs/plugin/math/math.js"></script>
  <script>window.define = window.backupDefine; window.backupDefine = undefined;</script>

  <script>

      // Full list of configuration options available at:
      // https://revealjs.com/config/
      Reveal.initialize({
'controlsAuto': true,
'previewLinksAuto': false,
'smaller': false,
'pdfSeparateFragments': false,
'autoAnimateEasing': "ease",
'autoAnimateDuration': 1,
'autoAnimateUnmatched': true,
'menu': {"side":"left","useTextContentForMissingTitles":true,"markers":false,"loadIcons":false,"custom":[{"title":"Tools","icon":"<i class=\"fas fa-gear\"></i>","content":"<ul class=\"slide-menu-items\">\n<li class=\"slide-tool-item active\" data-item=\"0\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.fullscreen(event)\"><kbd>f</kbd> Fullscreen</a></li>\n<li class=\"slide-tool-item\" data-item=\"1\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.speakerMode(event)\"><kbd>s</kbd> Speaker View</a></li>\n<li class=\"slide-tool-item\" data-item=\"2\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.overview(event)\"><kbd>o</kbd> Slide Overview</a></li>\n<li class=\"slide-tool-item\" data-item=\"3\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.togglePdfExport(event)\"><kbd>e</kbd> PDF Export Mode</a></li>\n<li class=\"slide-tool-item\" data-item=\"4\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.toggleChalkboard(event)\"><kbd>b</kbd> Toggle Chalkboard</a></li>\n<li class=\"slide-tool-item\" data-item=\"5\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.toggleNotesCanvas(event)\"><kbd>c</kbd> Toggle Notes Canvas</a></li>\n<li class=\"slide-tool-item\" data-item=\"6\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.downloadDrawings(event)\"><kbd>d</kbd> Download Drawings</a></li>\n<li class=\"slide-tool-item\" data-item=\"7\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.keyboardHelp(event)\"><kbd>?</kbd> Keyboard Help</a></li>\n</ul>"}],"openButton":true},
'chalkboard': {"buttons":false},
'smaller': false,
 
        // Display controls in the bottom right corner
        controls: false,

        // Help the user learn the controls by providing hints, for example by
        // bouncing the down arrow when they first encounter a vertical slide
        controlsTutorial: false,

        // Determines where controls appear, "edges" or "bottom-right"
        controlsLayout: 'edges',

        // Visibility rule for backwards navigation arrows; "faded", "hidden"
        // or "visible"
        controlsBackArrows: 'faded',

        // Display a presentation progress bar
        progress: true,

        // Display the page number of the current slide
        slideNumber: 'c/t',

        // 'all', 'print', or 'speaker'
        showSlideNumber: 'all',

        // Add the current slide number to the URL hash so that reloading the
        // page/copying the URL will return you to the same slide
        hash: true,

        // Start with 1 for the hash rather than 0
        hashOneBasedIndex: false,

        // Flags if we should monitor the hash and change slides accordingly
        respondToHashChanges: true,

        // Push each slide change to the browser history
        history: true,

        // Enable keyboard shortcuts for navigation
        keyboard: true,

        // Enable the slide overview mode
        overview: true,

        // Disables the default reveal.js slide layout (scaling and centering)
        // so that you can use custom CSS layout
        disableLayout: false,

        // Vertical centering of slides
        center: false,

        // Enables touch navigation on devices with touch input
        touch: true,

        // Loop the presentation
        loop: false,

        // Change the presentation direction to be RTL
        rtl: false,

        // see https://revealjs.com/vertical-slides/#navigation-mode
        navigationMode: 'linear',

        // Randomizes the order of slides each time the presentation loads
        shuffle: false,

        // Turns fragments on and off globally
        fragments: true,

        // Flags whether to include the current fragment in the URL,
        // so that reloading brings you to the same fragment position
        fragmentInURL: false,

        // Flags if the presentation is running in an embedded mode,
        // i.e. contained within a limited portion of the screen
        embedded: false,

        // Flags if we should show a help overlay when the questionmark
        // key is pressed
        help: true,

        // Flags if it should be possible to pause the presentation (blackout)
        pause: true,

        // Flags if speaker notes should be visible to all viewers
        showNotes: false,

        // Global override for autoplaying embedded media (null/true/false)
        autoPlayMedia: null,

        // Global override for preloading lazy-loaded iframes (null/true/false)
        preloadIframes: null,

        // Number of milliseconds between automatically proceeding to the
        // next slide, disabled when set to 0, this value can be overwritten
        // by using a data-autoslide attribute on your slides
        autoSlide: 0,

        // Stop auto-sliding after user input
        autoSlideStoppable: true,

        // Use this method for navigation when auto-sliding
        autoSlideMethod: null,

        // Specify the average time in seconds that you think you will spend
        // presenting each slide. This is used to show a pacing timer in the
        // speaker view
        defaultTiming: null,

        // Enable slide navigation via mouse wheel
        mouseWheel: false,

        // The display mode that will be used to show slides
        display: 'block',

        // Hide cursor if inactive
        hideInactiveCursor: true,

        // Time before the cursor is hidden (in ms)
        hideCursorTime: 5000,

        // Opens links in an iframe preview overlay
        previewLinks: false,

        // Transition style (none/fade/slide/convex/concave/zoom)
        transition: 'none',

        // Transition speed (default/fast/slow)
        transitionSpeed: 'default',

        // Transition style for full page slide backgrounds
        // (none/fade/slide/convex/concave/zoom)
        backgroundTransition: 'none',

        // Number of slides away from the current that are visible
        viewDistance: 3,

        // Number of slides away from the current that are visible on mobile
        // devices. It is advisable to set this to a lower number than
        // viewDistance in order to save resources.
        mobileViewDistance: 2,

        // The "normal" size of the presentation, aspect ratio will be preserved
        // when the presentation is scaled to fit different resolutions. Can be
        // specified using percentage units.
        width: 1050,

        height: 700,

        // Factor of the display size that should remain empty around the content
        margin: 0.1,

        math: {
          mathjax: 'https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js',
          config: 'TeX-AMS_HTML-full',
          tex2jax: {
            inlineMath: [['\\(','\\)']],
            displayMath: [['\\[','\\]']],
            balanceBraces: true,
            processEscapes: false,
            processRefs: true,
            processEnvironments: true,
            preview: 'TeX',
            skipTags: ['script','noscript','style','textarea','pre','code'],
            ignoreClass: 'tex2jax_ignore',
            processClass: 'tex2jax_process'
          },
        },

        // reveal.js plugins
        plugins: [QuartoLineHighlight, PdfExport, RevealMenu, RevealChalkboard, QuartoSupport,

          RevealMath,
          RevealNotes,
          RevealSearch,
          RevealZoom
        ]
      });
    </script>
    
    <script>
      // htmlwidgets need to know to resize themselves when slides are shown/hidden.
      // Fire the "slideenter" event (handled by htmlwidgets.js) when the current
      // slide changes (different for each slide format).
      (function () {
        // dispatch for htmlwidgets
        function fireSlideEnter() {
          const event = window.document.createEvent("Event");
          event.initEvent("slideenter", true, true);
          window.document.dispatchEvent(event);
        }

        function fireSlideChanged(previousSlide, currentSlide) {
          fireSlideEnter();

          // dispatch for shiny
          if (window.jQuery) {
            if (previousSlide) {
              window.jQuery(previousSlide).trigger("hidden");
            }
            if (currentSlide) {
              window.jQuery(currentSlide).trigger("shown");
            }
          }
        }

        // hookup for slidy
        if (window.w3c_slidy) {
          window.w3c_slidy.add_observer(function (slide_num) {
            // slide_num starts at position 1
            fireSlideChanged(null, w3c_slidy.slides[slide_num - 1]);
          });
        }

      })();
    </script>

    <script id="quarto-html-after-body" type="application/javascript">
    window.document.addEventListener("DOMContentLoaded", function (event) {
      const toggleBodyColorMode = (bsSheetEl) => {
        const mode = bsSheetEl.getAttribute("data-mode");
        const bodyEl = window.document.querySelector("body");
        if (mode === "dark") {
          bodyEl.classList.add("quarto-dark");
          bodyEl.classList.remove("quarto-light");
        } else {
          bodyEl.classList.add("quarto-light");
          bodyEl.classList.remove("quarto-dark");
        }
      }
      const toggleBodyColorPrimary = () => {
        const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
        if (bsSheetEl) {
          toggleBodyColorMode(bsSheetEl);
        }
      }
      toggleBodyColorPrimary();  
      const tabsets =  window.document.querySelectorAll(".panel-tabset-tabby")
      tabsets.forEach(function(tabset) {
        const tabby = new Tabby('#' + tabset.id);
      });
      const isCodeAnnotation = (el) => {
        for (const clz of el.classList) {
          if (clz.startsWith('code-annotation-')) {                     
            return true;
          }
        }
        return false;
      }
      const clipboard = new window.ClipboardJS('.code-copy-button', {
        text: function(trigger) {
          const codeEl = trigger.previousElementSibling.cloneNode(true);
          for (const childEl of codeEl.children) {
            if (isCodeAnnotation(childEl)) {
              childEl.remove();
            }
          }
          return codeEl.innerText;
        }
      });
      clipboard.on('success', function(e) {
        // button target
        const button = e.trigger;
        // don't keep focus
        button.blur();
        // flash "checked"
        button.classList.add('code-copy-button-checked');
        var currentTitle = button.getAttribute("title");
        button.setAttribute("title", "Copied!");
        let tooltip;
        if (window.bootstrap) {
          button.setAttribute("data-bs-toggle", "tooltip");
          button.setAttribute("data-bs-placement", "left");
          button.setAttribute("data-bs-title", "Copied!");
          tooltip = new bootstrap.Tooltip(button, 
            { trigger: "manual", 
              customClass: "code-copy-button-tooltip",
              offset: [0, -8]});
          tooltip.show();    
        }
        setTimeout(function() {
          if (tooltip) {
            tooltip.hide();
            button.removeAttribute("data-bs-title");
            button.removeAttribute("data-bs-toggle");
            button.removeAttribute("data-bs-placement");
          }
          button.setAttribute("title", currentTitle);
          button.classList.remove('code-copy-button-checked');
        }, 1000);
        // clear code selection
        e.clearSelection();
      });
      function tippyHover(el, contentFn) {
        const config = {
          allowHTML: true,
          content: contentFn,
          maxWidth: 500,
          delay: 100,
          arrow: false,
          appendTo: function(el) {
              return el.closest('section.slide') || el.parentElement;
          },
          interactive: true,
          interactiveBorder: 10,
          theme: 'light-border',
          placement: 'bottom-start'
        };
          config['offset'] = [0,0];
          config['maxWidth'] = 700;
        window.tippy(el, config); 
      }
      const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
      for (var i=0; i<noterefs.length; i++) {
        const ref = noterefs[i];
        tippyHover(ref, function() {
          // use id or data attribute instead here
          let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
          try { href = new URL(href).hash; } catch {}
          const id = href.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          return note.innerHTML;
        });
      }
      const findCites = (el) => {
        const parentEl = el.parentElement;
        if (parentEl) {
          const cites = parentEl.dataset.cites;
          if (cites) {
            return {
              el,
              cites: cites.split(' ')
            };
          } else {
            return findCites(el.parentElement)
          }
        } else {
          return undefined;
        }
      };
      var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
      for (var i=0; i<bibliorefs.length; i++) {
        const ref = bibliorefs[i];
        const citeInfo = findCites(ref);
        if (citeInfo) {
          tippyHover(citeInfo.el, function() {
            var popup = window.document.createElement('div');
            citeInfo.cites.forEach(function(cite) {
              var citeDiv = window.document.createElement('div');
              citeDiv.classList.add('hanging-indent');
              citeDiv.classList.add('csl-entry');
              var biblioDiv = window.document.getElementById('ref-' + cite);
              if (biblioDiv) {
                citeDiv.innerHTML = biblioDiv.innerHTML;
              }
              popup.appendChild(citeDiv);
            });
            return popup.innerHTML;
          });
        }
      }
    });
    </script>
    

</body></html>